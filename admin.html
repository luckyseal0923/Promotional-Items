<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¬é—œå“å¾Œè‡ºç®¡ç†ç³»çµ±</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --danger: #dc2626;
            --warning: #ca8a04;
            --info: #0891b2;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
        }

        body, html { height: 100%; margin: 0; font-family: "PingFang TC", sans-serif; background: var(--bg); color: var(--text); }
        .hidden { display: none !important; }

        /* ç™»å…¥é  */
        #loginView {
            display: flex; align-items: center; justify-content: center;
            height: 100vh; background: #0f172a; position: fixed; inset: 0; z-index: 9999;
        }
        .login-card { background: white; padding: 40px; border-radius: 16px; width: 320px; text-align: center; }

        /* ä¸»ä½ˆå±€ */
        #adminView { display: none; min-height: 100vh; }
        .sidebar {
            width: 260px; background: #1e293b; height: 100vh; position: fixed;
            padding: 24px; color: white; box-sizing: border-box;
        }
        .main-content { margin-left: 260px; padding: 40px; }

        .nav-item { 
            padding: 12px 16px; border-radius: 8px; margin-bottom: 8px; cursor: pointer; color: #94a3b8; transition: 0.3s;
        }
        .nav-item.active { background: var(--primary); color: white; }

        /* é¢æ¿èˆ‡å¡ç‰‡ */
        .panel { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 24px; }
        h1 { font-size: 24px; margin-bottom: 24px; }

        /* è¡¨æ ¼èˆ‡æŒ‰éˆ• */
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { text-align: left; padding: 12px; background: #f1f5f9; color: #475569; }
        td { padding: 16px 12px; border-bottom: 1px solid #f1f5f9; }

        .btn { padding: 8px 14px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }

        /* ç‹€æ…‹æ¨™ç±¤ */
        .status-pill { padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .status-1 { background: #e0f2fe; color: #0369a1; } /* ç”³è«‹æå‡º */
        .status-2 { background: #fef9c3; color: #854d0e; } /* å•†å“æº–å‚™ä¸­ */
        .status-3 { background: #dcfce7; color: #15803d; } /* é€šçŸ¥é ˜å– */
        .status-4 { background: #fee2e2; color: #b91c1c; } /* ç•°å¸¸é€šçŸ¥ */

        /* ç¯©é¸æ¬„ */
        .filter-bar { display: flex; gap: 15px; align-items: flex-end; margin-bottom: 20px; }
        input, select { padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; }

        /* å½ˆçª— */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 5000;
        }
        .modal-body { background: white; padding: 30px; border-radius: 12px; width: 500px; max-height: 80vh; overflow-y: auto; }
    </style>
</head>
<body>

    <div id="loginView">
        <div class="login-card">
            <h2>å…¬é—œå“ç®¡ç†å¾Œè‡º</h2>
            <input type="text" id="user" placeholder="å¸³è™Ÿ" value="admin" style="width:100%; margin-bottom:10px; box-sizing:border-box">
            <input type="password" id="pass" placeholder="å¯†ç¢¼" value="1234" style="width:100%; margin-bottom:20px; box-sizing:border-box">
            <button class="btn btn-primary" style="width:100%" onclick="handleLogin()">ç™»å…¥</button>
        </div>
    </div>

    <div id="adminView">
        <div class="sidebar">
            <h2 style="font-size:18px; margin-bottom:40px">å…¬é—œå“ç®¡ç†ç³»çµ±</h2>
            <div class="nav-item active" id="nav-orders" onclick="switchTab('orders')">ğŸ“‹ è¨‚å–®ç®¡ç†ç³»çµ±</div>
            <div class="nav-item" id="nav-inventory" onclick="switchTab('inventory')">ğŸ“¦ å•†å“åº«å­˜ç¶­è­·</div>
            <div class="nav-item" id="nav-accounts" onclick="switchTab('accounts')">ğŸ‘¥ å¸³è™Ÿå¯†ç¢¼è¨­å®š</div>
            <div style="margin-top:50px">
                <button class="btn btn-outline" style="width:100%" onclick="location.reload()">å®‰å…¨ç™»å‡º</button>
            </div>
        </div>

        <div class="main-content">
            <div id="tab-orders">
                <h1>è¨‚å–®ç®¡ç†ç³»çµ±</h1>
                <div class="panel">
                    <div class="filter-bar">
                        <div>
                            <label style="font-size:12px; display:block">é–‹å§‹æ—¥æœŸ</label>
                            <input type="date" id="filterStart">
                        </div>
                        <div>
                            <label style="font-size:12px; display:block">çµæŸæ—¥æœŸ</label>
                            <input type="date" id="filterEnd">
                        </div>
                        <button class="btn btn-outline" onclick="filterOrders()">ç¯©é¸å€é–“</button>
                        <button class="btn btn-success" onclick="downloadCSV()">ä¸‹è¼‰ CSV</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>æ—¥æœŸ</th><th>å–®è™Ÿ</th><th>ç”³è«‹äºº</th><th>å…§å®¹æ˜ç´°</th><th>ç•¶å‰ç‹€æ…‹</th><th>ç‹€æ…‹æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="orderTable"></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-inventory" class="hidden">
                <h1>å•†å“ç¶­è­·</h1>
                <div class="panel">åº«å­˜ç¶­è­·åŠŸèƒ½ï¼ˆå¯åœ¨æ­¤æ–°å¢/ç§»é™¤å•†å“ï¼‰</div>
            </div>

            <div id="tab-accounts" class="hidden">
                <h1>ç³»çµ±å¸³è™Ÿç®¡ç†</h1>
                <div class="panel">
                    <h3>æ–°å¢ç®¡ç†å“¡</h3>
                    <div style="display:flex; gap:10px; margin-bottom:20px">
                        <input type="text" id="newAccUser" placeholder="æ–°å¸³è™Ÿ">
                        <input type="password" id="newAccPass" placeholder="æ–°å¯†ç¢¼">
                        <button class="btn btn-primary" onclick="addAccount()">æ–°å¢å¸³è™Ÿ</button>
                    </div>
                    <hr>
                    <table style="margin-top:20px">
                        <thead><tr><th>å¸³è™Ÿåç¨±</th><th>è§’è‰²</th><th>æ“ä½œ</th></tr></thead>
                        <tbody id="accountTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="orderModal" class="modal">
        <div class="modal-body">
            <h3 id="modalTitle">è¨‚å–®æ˜ç´°</h3>
            <div id="modalContent" style="margin-bottom:20px"></div>
            <div id="memoArea" class="hidden">
                <label>ç•°å¸¸å‚™è¨» (30-50å­—):</label>
                <textarea id="errorMemo" style="width:100%; height:80px; margin-top:10px" placeholder="è«‹æè¿°ç•°å¸¸åŸå› ..."></textarea>
            </div>
            <div style="display:flex; gap:10px; margin-top:20px">
                <button class="btn btn-outline" style="flex:1" onclick="closeModal()">é—œé–‰</button>
                <button id="saveBtn" class="btn btn-primary hidden" onclick="saveStatusChange()">å„²å­˜è®Šæ›´</button>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–å¸³è™Ÿèˆ‡è¨‚å–®
        let ACCOUNTS = [{user: 'admin', pass: '1234', role: 'è¶…ç´šç®¡ç†å“¡'}];
        let ORDERS = [
            {id:'ORD-001', date:'2026-02-10', user:'é™³é†«ç”Ÿ', items:[{n:'å¹³å®‰åŒ…', q:2}, {n:'åŸå­ç­†', q:10}], status:'ç”³è«‹æå‡º', memo:''},
            {id:'ORD-002', date:'2026-02-11', user:'æ—è­·ç†å¸«', items:[{n:'çº–ç¶­è¢‹', q:5}], status:'å•†å“æº–å‚™ä¸­', memo:''},
            {id:'ORD-003', date:'2026-02-12', user:'å¼µå°ˆå“¡', items:[{n:'å¹³å®‰åŒ…', q:1}], status:'é€šçŸ¥é ˜å–', memo:''},
            {id:'ORD-004', date:'2026-02-13', user:'æä¸»ä»»', items:[{n:'ç²¾è£½ç­†', q:20}], status:'ç•°å¸¸é€šçŸ¥', memo:'åº«å­˜ä¸è¶³ï¼Œé è¨ˆä¸‹é€±åˆ°è²¨'}
        ];

        function handleLogin() {
            const u = document.getElementById('user').value;
            const p = document.getElementById('pass').value;
            const valid = ACCOUNTS.find(a => a.user === u && a.pass === p);
            if(valid) {
                document.getElementById('loginView').style.display = 'none';
                document.getElementById('adminView').style.display = 'block';
                renderOrders();
                renderAccounts();
            } else { alert('å¸³å¯†éŒ¯èª¤'); }
        }

        function switchTab(tabId) {
            ['orders', 'inventory', 'accounts'].forEach(t => {
                document.getElementById('tab-'+t).classList.add('hidden');
                document.getElementById('nav-'+t).classList.remove('active');
            });
            document.getElementById('tab-'+tabId).classList.remove('hidden');
            document.getElementById('nav-'+tabId).classList.add('active');
        }

        function renderOrders(data = ORDERS) {
            const body = document.getElementById('orderTable');
            body.innerHTML = data.map(o => `
                <tr>
                    <td>${o.date}</td><td><b>${o.id}</b></td><td>${o.user}</td>
                    <td><button class="btn btn-outline" onclick="showDetail('${o.id}')">æŸ¥çœ‹ (å…± ${o.items.length} é …)</button></td>
                    <td><span class="status-pill status-${getStatusID(o.status)}">${o.status}</span></td>
                    <td>
                        <select onchange="updateStatus('${o.id}', this.value)">
                            <option value="">è½‰æ›ç‹€æ…‹...</option>
                            <option value="ç”³è«‹æå‡º">ç”³è«‹æå‡º</option>
                            <option value="å•†å“æº–å‚™ä¸­">å•†å“æº–å‚™ä¸­</option>
                            <option value="é€šçŸ¥é ˜å–">é€šçŸ¥é ˜å– (ç™¼ä¿¡)</option>
                            <option value="ç•°å¸¸é€šçŸ¥">ç•°å¸¸é€šçŸ¥</option>
                        </select>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusID(s) {
            if(s==='ç”³è«‹æå‡º') return 1; if(s==='å•†å“æº–å‚™ä¸­') return 2;
            if(s==='é€šçŸ¥é ˜å–') return 3; if(s==='ç•°å¸¸é€šçŸ¥') return 4;
        }

        function showDetail(id) {
            const o = ORDERS.find(order => order.id === id);
            document.getElementById('modalTitle').innerText = 'è¨‚å–®æ˜ç´° - ' + id;
            document.getElementById('modalContent').innerHTML = o.items.map(i => `<p>${i.n} x ${i.q}</p>`).join('') + 
                (o.memo ? `<hr><p style="color:red">å‚™è¨»ï¼š${o.memo}</p>` : '');
            document.getElementById('memoArea').classList.add('hidden');
            document.getElementById('saveBtn').classList.add('hidden');
            document.getElementById('orderModal').style.display = 'flex';
        }

        let pendingStatus = { id: '', status: '' };
        function updateStatus(id, newStatus) {
            if(!newStatus) return;
            if(newStatus === 'é€šçŸ¥é ˜å–') {
                if(confirm('å°‡è‡ªå‹•ä¸²è¯ Workflow ç™¼é€éƒµä»¶é€šçŸ¥é ˜å–ï¼Œç¢ºå®šå—ï¼Ÿ')) {
                    // é€™è£¡ä¸²æ¥ä½ çš„ n8n Webhook
                    console.log('Triggering n8n Workflow for:', id);
                    alert(id + ' å·²è§¸ç™¼ Workflow ç™¼ä¿¡æˆåŠŸï¼');
                    applyStatus(id, newStatus);
                }
            } else if(newStatus === 'ç•°å¸¸é€šçŸ¥') {
                pendingStatus = { id, status: newStatus };
                document.getElementById('modalTitle').innerText = 'å¡«å¯«ç•°å¸¸å‚™è¨»';
                document.getElementById('modalContent').innerHTML = 'è«‹è¼¸å…¥ç•°å¸¸åŸå› ï¼š';
                document.getElementById('memoArea').classList.remove('hidden');
                document.getElementById('saveBtn').classList.remove('hidden');
                document.getElementById('orderModal').style.display = 'flex';
            } else {
                applyStatus(id, newStatus);
            }
        }

        function saveStatusChange() {
            const memo = document.getElementById('errorMemo').value;
            if(memo.length < 5) return alert('å‚™è¨»å­—æ•¸ä¸è¶³');
            applyStatus(pendingStatus.id, pendingStatus.status, memo);
            closeModal();
        }

        function applyStatus(id, status, memo = '') {
            const o = ORDERS.find(order => order.id === id);
            o.status = status;
            if(memo) o.memo = memo;
            renderOrders();
        }

        function filterOrders() {
            const start = document.getElementById('filterStart').value;
            const end = document.getElementById('filterEnd').value;
            if(!start || !end) return alert('è«‹é¸æ“‡å®Œæ•´å€é–“');
            const filtered = ORDERS.filter(o => o.date >= start && o.date <= end);
            renderOrders(filtered);
        }

        function downloadCSV() {
            let csv = 'æ—¥æœŸ,å–®è™Ÿ,ç”³è«‹äºº,ç‹€æ…‹,é‡‘é¡\n';
            ORDERS.forEach(o => csv += `${o.date},${o.id},${o.user},${o.status},0\n`);
            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "è¨‚å–®å ±è¡¨.csv";
            link.click();
        }

        function addAccount() {
            const u = document.getElementById('newAccUser').value;
            const p = document.getElementById('newAccPass').value;
            if(!u || !p) return;
            ACCOUNTS.push({user: u, pass: p, role: 'ç®¡ç†å“¡'});
            renderAccounts();
            alert('æ–°å¢æˆåŠŸ');
        }

        function renderAccounts() {
            document.getElementById('accountTable').innerHTML = ACCOUNTS.map(a => `
                <tr><td>${a.user}</td><td>${a.role}</td><td><button class="btn btn-danger" onclick="alert('ä¸èƒ½åˆªé™¤åˆå§‹å¸³è™Ÿ')">åœç”¨</button></td></tr>
            `).join('');
        }

        function closeModal() { document.getElementById('orderModal').style.display = 'none'; }
    </script>
</body>
</html>
