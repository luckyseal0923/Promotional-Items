<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å…¬é—œå“å¾Œè‡ºç®¡ç†ç³»çµ± - Phase 3 ç©©å®šç‰ˆ</title>

<style>
:root{
  --primary:#10B981;--bg:#F8FAFC;--text:#334155;
  --border:#E2E8F0;--danger:#EF4444;
}
body,html{margin:0;height:100%;font-family:"PingFang TC",sans-serif;background:var(--bg);color:var(--text)}
.hidden{display:none!important}

/* Sidebar */
.sidebar{width:260px;background:#fff;height:100vh;position:fixed;
  padding:24px;border-right:1px solid var(--border);box-sizing:border-box}
.main-content{margin-left:260px;padding:30px}
.nav-item{padding:14px 18px;border-radius:10px;margin-bottom:8px;
  cursor:pointer;color:#64748B;display:flex;gap:12px}
.nav-item.active{background:var(--primary);color:#fff;font-weight:bold}

/* Panel / Table */
.panel{background:#fff;border-radius:12px;padding:24px;border:1px solid var(--border);margin-bottom:24px}
h1{font-size:22px;border-left:5px solid var(--primary);padding-left:14px}
table{width:100%;border-collapse:collapse}
th,td{padding:12px;border-bottom:1px solid var(--border)}
th{background:#F8FAFC}

/* Buttons */
.btn{padding:10px 16px;border-radius:8px;border:none;cursor:pointer;font-size:13px}
.btn-outline{background:#fff;border:1px solid var(--border)}
.btn-danger{background:var(--danger);color:#fff}

/* Status */
.status-pill{padding:4px 10px;border-radius:6px;font-size:12px;font-weight:bold}
.status-1{background:#DBEAFE;color:#1E40AF}
.status-4{background:#FEE2E2;color:#991B1B}

/* Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center}
.modal-body{background:#fff;padding:24px;border-radius:14px;width:100%;max-width:520px}
</style>
</head>

<body>

<div id="adminView">
  <div class="sidebar">
    <h2 style="color:var(--primary)">å…¬é—œå“å¾Œè‡º</h2>
    <div class="nav-item active" id="nav-orders" onclick="switchTab('orders')">ğŸ“‹ è¨‚å–®ç®¡ç†</div>
    <div class="nav-item" id="nav-inventory" onclick="switchTab('inventory')">âš–ï¸ åº«å­˜ç›¤é»</div>
    <div class="nav-item" id="nav-listing" onclick="switchTab('listing')">ğŸš€ å•†å“ç®¡ç†</div>
    <div class="nav-item" id="nav-accounts" onclick="switchTab('accounts')">ğŸ‘¥ å¸³è™Ÿç®¡ç†</div>
    <button class="btn btn-outline" style="width:100%;margin-top:40px">å®‰å…¨ç™»å‡º</button>
  </div>

  <div class="main-content">

    <!-- è¨‚å–®ç®¡ç† -->
    <div id="tab-orders">
      <h1>è¨‚å–®ç®¡ç†ç³»çµ±</h1>

      <!-- éŒ¯èª¤æç¤ºï¼ˆé è¨­é¡¯ç¤ºï¼‰ -->
      <div id="orderError"
        style="padding:14px;border-radius:10px;background:#FEE2E2;
               color:#991B1B;font-weight:bold;margin-bottom:16px">
        âš ï¸ è¨‚å–®è³‡æ–™ç›®å‰ç„¡æ³•è¼‰å…¥ï¼ˆç³»çµ±ä»å¯æ“ä½œï¼Œè«‹ç¨å¾Œå†è©¦ï¼‰
      </div>

      <div class="panel">
        <table>
          <thead>
            <tr>
              <th>æ—¥æœŸ</th>
              <th>å–®è™Ÿ</th>
              <th>ç”³è«‹äºº</th>
              <th>ç‹€æ…‹</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="orderTable">
            <tr>
              <td colspan="5" style="text-align:center;color:#666;padding:30px">
                å°šç„¡è¨‚å–®è³‡æ–™
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div id="tab-inventory" class="hidden">
      <h1>åº«å­˜ç›¤é»</h1>
      <div class="panel">ï¼ˆåŠŸèƒ½ä¿ç•™ï¼Œæœªä¿®æ”¹ï¼‰</div>
    </div>

    <div id="tab-listing" class="hidden">
      <h1>å•†å“ç®¡ç†</h1>
      <div class="panel">ï¼ˆåŠŸèƒ½ä¿ç•™ï¼Œæœªä¿®æ”¹ï¼‰</div>
    </div>

    <div id="tab-accounts" class="hidden">
      <h1>å¸³è™Ÿç®¡ç†</h1>
      <div class="panel">ï¼ˆåŠŸèƒ½ä¿ç•™ï¼Œæœªä¿®æ”¹ï¼‰</div>
    </div>

  </div>
</div>

<script>
/* =========================
   API Endpointï¼ˆn8nï¼‰
========================= */
const API_ORDERS = 'https://chihwei-n8n.zeabur.app/webhook/orders';
const API_UPDATE_STATUS = 'https://chihwei-n8n.zeabur.app/webhook/update-order';
const API_INVENTORY = 'https://chihwei-n8n.zeabur.app/webhook/inventory';

/* =========================
   å…¨åŸŸç‹€æ…‹
========================= */
let ORDERS = [];

/* =========================
   Tab åˆ‡æ›ï¼ˆåŸåŠŸèƒ½ï¼‰
========================= */
function switchTab(tab){
  ['orders','inventory','listing','accounts'].forEach(t=>{
    document.getElementById('tab-'+t).classList.add('hidden');
    document.getElementById('nav-'+t).classList.remove('active');
  });
  document.getElementById('tab-'+tab).classList.remove('hidden');
  document.getElementById('nav-'+tab).classList.add('active');
}

/* =========================
   è¨‚å–®è¼‰å…¥ï¼ˆä¿®æ­£ç‰ˆï¼‰
========================= */
async function loadOrders(){
  try{
    const res = await fetch(API_ORDERS);
    if(!res.ok) throw new Error('API error');

    const data = await res.json();
    
    // âœ… ä¿®æ­£ï¼šåˆä½µ active å’Œ archived é™£åˆ—
    const activeOrders = data.orders?.active || [];
    const archivedOrders = data.orders?.archived || [];
    ORDERS = [...activeOrders, ...archivedOrders];

    console.log('è¼‰å…¥è¨‚å–®æˆåŠŸ:', ORDERS.length, 'ç­†');

    document.getElementById('orderError').classList.add('hidden');
    renderOrders();
  }catch(e){
    console.warn('è¨‚å–®è¼‰å…¥å¤±æ•—', e);
    document.getElementById('orderError').classList.remove('hidden');
  }
}

function renderOrders(){
  const tbody = document.getElementById('orderTable');
  if(ORDERS.length === 0){
    tbody.innerHTML = `
      <tr>
        <td colspan="5" style="text-align:center;color:#666;padding:30px">
          å°šç„¡è¨‚å–®è³‡æ–™
        </td>
      </tr>`;
    return;
  }

  tbody.innerHTML = ORDERS.map(o=>`
    <tr>
      <td>${formatDate(o.date)}</td>
      <td><b>${o.task_id || '-'}</b></td>
      <td>${o.user || '-'}</td>
      <td>
        <span class="status-pill ${getStatusClass(o.status)}">${o.status || '-'}</span>
      </td>
      <td>
        <button class="btn btn-outline" onclick="viewOrder('${o.task_id}')">æŸ¥çœ‹</button>
      </td>
    </tr>
  `).join('');
}

/* =========================
   è¼”åŠ©å‡½å¼
========================= */
function formatDate(dateStr){
  if(!dateStr) return '-';
  const d = new Date(dateStr);
  return d.toLocaleDateString('zh-TW');
}

function getStatusClass(status){
  const s = (status || '').toLowerCase();
  if(['done', 'closed', 'completed'].includes(s)) return 'status-4';
  return 'status-1';
}

function viewOrder(taskId){
  const order = ORDERS.find(o => o.task_id === taskId);
  if(order){
    alert(`è¨‚å–®è©³æƒ…:\n${JSON.stringify(order, null, 2)}`);
  }
}

/* =========================
   åˆå§‹åŒ–
========================= */
window.onload = () => {
  loadOrders();
};
</script>

</body>
</html>
