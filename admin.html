<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å…¬é—œå“å¾Œè‡ºç®¡ç†ç³»çµ±</title>
<style>
:root { --primary: #10B981; --primary-dark: #059669; --bg: #F8FAFC; --text: #334155; --border: #E2E8F0; --danger: #EF4444; }
body,html{margin:0;height:100%;font-family:"PingFang TC",sans-serif;background:var(--bg);color:var(--text)}
.hidden{display:none!important}
.sidebar{width:260px;background:#fff;height:100vh;position:fixed;padding:24px;border-right:1px solid var(--border);box-sizing:border-box;z-index:100}
.main-content{margin-left:260px;padding:30px}
@media (max-width: 900px) { .sidebar{width:70px;padding:15px 5px;text-align:center} .sidebar h2,.sidebar .nav-text{display:none} .main-content{margin-left:70px;padding:15px} }
.nav-item{padding:14px 18px;border-radius:10px;margin-bottom:8px;cursor:pointer;color:#64748B;display:flex;align-items:center;gap:12px;transition:0.2s}
.nav-item.active{background:var(--primary);color:#fff;font-weight:bold}
.panel{background:#fff;border-radius:12px;padding:24px;border:1px solid var(--border);margin-bottom:24px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
h1{font-size:22px;border-left:5px solid var(--primary);padding-left:14px;margin-bottom:24px;color:#0F172A}
table{width:100%;border-collapse:collapse;min-width:800px}
th{text-align:left;padding:12px;background:#F8FAFC;border-bottom:2px solid var(--border);font-size:13px}
td{padding:16px 12px;border-bottom:1px solid var(--border);font-size:14px}
.table-wrapper{overflow-x:auto}
.btn{padding:10px 16px;border-radius:8px;border:none;cursor:pointer;font-size:13px;font-weight:600;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:var(--primary);color:#fff}
.btn-success{background:#10B981;color:#fff}
.btn-outline{background:#fff;border:1px solid var(--border);color:var(--text)}
.status-pill{padding:4px 10px;border-radius:6px;font-size:12px;font-weight:bold}
.status-preparing{background:#DBEAFE;color:#1E40AF}
.status-submitted{background:#FEF3C7;color:#92400E}
.status-ready{background:#D1FAE5;color:#065F46}
.status-exception{background:#FEE2E2;color:#991B1B}
.status-end{background:#E5E7EB;color:#374151}
input,select{padding:12px;border:1px solid var(--border);border-radius:8px;outline:none;box-sizing:border-box;font-size:14px}
.modal{position:fixed;inset:0;background:rgba(15,23,42,0.5);display:none;align-items:center;justify-content:center;z-index:5000;padding:15px}
.modal.show{display:flex}
.modal-body{background:#fff;padding:30px;border-radius:16px;width:100%;max-width:550px;max-height:90vh;overflow-y:auto}
.info-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px dashed #E2E8F0}
.info-label{color:#64748B;font-size:14px} .info-value{font-weight:600;font-size:14px}
</style>
</head>
<body>
  <div id="adminView">
  <div class="sidebar">
    <h2 style="color:var(--primary-dark);margin-bottom:30px">å…¬é—œå“å¾Œè‡º</h2>
    <div class="nav-item active" id="nav-orders" onclick="switchTab('orders')">ğŸ“‹ <span class="nav-text">è¨‚å–®ç®¡ç†ç³»çµ±</span></div>
    <div class="nav-item" id="nav-inventory" onclick="switchTab('inventory')">âš–ï¸ <span class="nav-text">åº«å­˜ç›¤é»</span></div>
    <div class="nav-item" id="nav-listing" onclick="switchTab('listing')">ğŸš€ <span class="nav-text">å•†å“ç®¡ç†</span></div>
    <div class="nav-item" id="nav-accounts" onclick="switchTab('accounts')">ğŸ‘¥ <span class="nav-text">å¸³è™Ÿç®¡ç†</span></div>
    <div style="margin-top:50px"><button class="btn btn-outline" style="width:100%">å®‰å…¨ç™»å‡º</button></div>
  </div>

  <div class="main-content">
    <!-- è¨‚å–® -->
    <div id="tab-orders">
      <h1>è¨‚å–®ç®¡ç†ç³»çµ±</h1>
      <div id="orderError" class="hidden" style="padding:14px;background:#FEE2E2;color:#991B1B;border-radius:10px;margin-bottom:16px">âš ï¸ è¼‰å…¥å¤±æ•—</div>
      <div class="panel">
        <div style="display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;align-items:center">
          <input type="date" id="dateFrom" onchange="filterOrders()"> è‡³ <input type="date" id="dateTo" onchange="filterOrders()">
          <select id="statusFilter" onchange="filterOrders()" style="min-width:120px">
            <option value="">å…¨éƒ¨ç‹€æ…‹</option>
            <option value="Submitted">ç”³è«‹æå‡º</option>
            <option value="PREPARING">å•†å“æº–å‚™ä¸­</option>
            <option value="ready">é€šçŸ¥é ˜å–</option>
            <option value="EXCEPTION">ç•°å¸¸é€šçŸ¥</option>
            <option value="End">æ¡ˆä»¶çµæ¡ˆ</option>
          </select>
          <input type="text" id="searchKeyword" placeholder="æœå°‹å–®è™Ÿ/ç”³è«‹äºº" style="width:150px">
          <button class="btn btn-primary" onclick="filterOrders()">ğŸ” ç¯©é¸</button>
          <button class="btn btn-outline" onclick="resetFilter()">é‡ç½®</button>
          <button class="btn btn-success" onclick="downloadCSV()">ğŸ“¥ ä¸‹è¼‰å ±è¡¨</button>
        </div>
        <div class="table-wrapper">
          <table>
            <thead><tr><th>æ—¥æœŸ / å–®è™Ÿ</th><th>ç”³è«‹äºº</th><th>å–®ä½</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="orderTable"><tr><td colspan="5" style="text-align:center;padding:30px">è¼‰å…¥ä¸­...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
     <!-- åº«å­˜ -->
    <div id="tab-inventory" class="hidden">
      <h1>åº«å­˜ç›¤é»</h1>
      <div class="panel">è¼‰å…¥ä¸­...</div>
    </div>

    <!-- å•†å“ -->
    <div id="tab-listing" class="hidden">
      <h1>å•†å“ç®¡ç†</h1>
      <div class="panel">è¼‰å…¥ä¸­...</div>
    </div>

    <!-- å¸³è™Ÿ -->
    <div id="tab-accounts" class="hidden">
      <h1>å¸³è™Ÿç®¡ç†</h1>
      <div class="panel">ï¼ˆåŠŸèƒ½é–‹ç™¼ä¸­ï¼‰</div>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="orderModal" class="modal"><div class="modal-body"><h3 class="modal-title">ğŸ“‹ è¨‚å–®è©³ç´°è³‡è¨Š</h3><div id="orderDetail"></div><button class="btn btn-primary" style="width:100%;margin-top:20px" onclick="document.getElementById('orderModal').classList.remove('show')">é—œé–‰</button></div></div>

<script>
const API_ORDERS = 'https://chihwei-n8n.zeabur.app/webhook/orders';
const API_INVENTORY_LIST = 'https://chihwei-n8n.zeabur.app/webhook/inventory-list';
const API_INVENTORY_UPDATE = 'https://chihwei-n8n.zeabur.app/webhook/inventory-update';
const API_PRODUCT_SAVE = 'https://chihwei-n8n.zeabur.app/webhook/product-save';
const API_PRODUCT_UPLOAD = 'https://chihwei-n8n.zeabur.app/webhook/product-upload-image';

let ALL_ORDERS = [], FILTERED_ORDERS = [], ALL_PRODUCTS = [];

const STATUS_MAP = {'Submitted':'ç”³è«‹æå‡º','PREPARING':'å•†å“æº–å‚™ä¸­','preparing':'å•†å“æº–å‚™ä¸­','ready':'é€šçŸ¥é ˜å–','EXCEPTION':'ç•°å¸¸é€šçŸ¥','End':'æ¡ˆä»¶çµæ¡ˆ','done':'æ¡ˆä»¶çµæ¡ˆ','closed':'æ¡ˆä»¶çµæ¡ˆ'};
const STATUS_CLASS = {'Submitted':'status-submitted','PREPARING':'status-preparing','preparing':'status-preparing','ready':'status-ready','EXCEPTION':'status-exception','End':'status-end','done':'status-end','closed':'status-end'};
  function getStatusText(s){return STATUS_MAP[s]||s||'æœªçŸ¥';}
function getStatusClass(s){return STATUS_CLASS[s]||'status-preparing';}
function formatDate(d){if(!d)return'-';const n=new Date(d);return isNaN(n)?d:n.toLocaleDateString('zh-TW');}
function formatDateTime(d){if(!d)return'-';const n=new Date(d);return isNaN(n)?d:n.toLocaleString('zh-TW');}

function switchTab(tab){
  ['orders','inventory','listing','accounts'].forEach(t=>{
    document.getElementById('tab-'+t).classList.add('hidden');
    document.getElementById('nav-'+t).classList.remove('active');
  });
  document.getElementById('tab-'+tab).classList.remove('hidden');
  document.getElementById('nav-'+tab).classList.add('active');
  
  if(tab==='orders' && ALL_ORDERS.length===0) loadOrders();
  if(tab==='inventory') loadInventory();
  if(tab==='listing') loadListing();
}

/* è¨‚å–® */
async function loadOrders(){
  try{
    const res=await fetch(API_ORDERS);
    const data=await res.json();
    ALL_ORDERS=[...(data.orders?.active||[]),...(data.orders?.archived||[])];
    FILTERED_ORDERS=[...ALL_ORDERS];
    renderOrders();
  }catch(e){ console.error(e); document.getElementById('orderError').classList.remove('hidden'); }
}
  function filterOrders(){
  const df=document.getElementById('dateFrom').value, dt=document.getElementById('dateTo').value;
  const sf=document.getElementById('statusFilter').value, kw=document.getElementById('searchKeyword').value.toLowerCase().trim();
  FILTERED_ORDERS=ALL_ORDERS.filter(o=>{
    if(df || dt){ const od=o.date?new Date(o.date).toISOString().split('T')[0]:''; if(df&&od<df)return false; if(dt&&od>dt)return false; }
    if(sf && o.status!==sf) return false;
    if(kw && !(o.task_id||'').toLowerCase().includes(kw) && !(o.user||'').toLowerCase().includes(kw)) return false;
    return true;
  });
  renderOrders();
}
function resetFilter(){
  document.getElementById('dateFrom').value='';document.getElementById('dateTo').value='';document.getElementById('statusFilter').value='';document.getElementById('searchKeyword').value='';
  FILTERED_ORDERS=[...ALL_ORDERS]; renderOrders();
}

function renderOrders(){
  const tb=document.getElementById('orderTable');
  if(FILTERED_ORDERS.length===0){ tb.innerHTML='<tr><td colspan="5" style="text-align:center;padding:30px">ç„¡è³‡æ–™</td></tr>'; return; }
  tb.innerHTML=FILTERED_ORDERS.map(o=>
    `<tr>
      <td><div style="font-weight:bold">${formatDate(o.date)}</div><div style="font-size:11px;color:#999">${o.task_id||'-'}</div></td>
      <td>${o.user||'-'}</td><td>${o.department||'-'}</td>
      <td><span class="status-pill ${getStatusClass(o.status)}">${getStatusText(o.status)}</span></td>
      <td>
        <button class="btn btn-outline" onclick="showOrderDetail('${o.task_id}')">ğŸ“‹ æŸ¥è©¢</button>
        <button class="btn btn-primary" onclick="showEditStatus('${o.task_id}')">âœï¸ ç‹€æ…‹</button>
      </td>
    </tr>`
  ).join('');
}
function showOrderDetail(id) {
            const o = ORDERS.find(ord => ord.id === id);
            openModal(`
                <h3 style="margin-top:0">ğŸ“‹ è¨‚å–®è©³ç´°è³‡è¨Š</h3>
                <div class="panel" style="background:#F8FAFC">
                    <div class="info-row"><b>è¨‚å–®ç·¨è™Ÿ</b><span>${o.id}</span></div>
                    <div class="info-row"><b>ç”³è«‹æ—¥æœŸ</b><span>${o.date}</span></div>
                    <div class="info-row"><b>ç”³è«‹äººå§“å</b><span>${o.user}</span></div>
                    
                    <div class="info-row"><b>é™¢å…§å“¡ç·¨ (Task ID)</b><span>${o.task_id || 'æœªæä¾›'}</span></div>
                    <div class="info-row"><b>ç”³è«‹è€…é›»è©±</b><span>${o.phone}</span></div>
                    <div class="info-row"><b>é›»å­ä¿¡ç®±</b><span>${o.email}</span></div>
                    <div class="info-row"><b>ç”³è«‹å–®ä½</b><span>${o.dept}</span></div>
                    <div class="info-row"><b>æˆæœ¬ä¸­å¿ƒ</b><span>${o.cost_center}</span></div>
                    <div class="info-row"><b>é ˜å–äº‹ç”±</b><span>${o.reason}</span></div>
                </div>
                
                <h4>ğŸ“¦ å•†å“å…§å®¹</h4>
                <div class="panel">
                    ${o.items.map(i => `<p style="margin:5px 0">â— ${i.n} x ${i.q}</p>`).join('')}
                    ${o.memo ? `<p style="color:red; margin-top:10px"><b>âš ï¸ ç•°å¸¸å‚™è¨»ï¼š</b>${o.memo}</p>` : ''}
                </div>
                
                <button class="btn btn-primary" style="width:100%; margin-top:15px; padding:12px" onclick="closeModal()">é—œé–‰è¦–çª—</button>
            `);
        }

function showEditStatus(tid){
  const o=ALL_ORDERS.find(x=>x.task_id===tid); if(!o)return;
  let h=`<div style="margin-bottom:15px">ç›®å‰ç‹€æ…‹ï¼š<span class="status-pill ${getStatusClass(o.status)}">${getStatusText(o.status)}</span></div>`;
  h+=`<select id="newStatus" style="width:100%" onchange="toggleReason()"><option value="Submitted">ç”³è«‹æå‡º</option><option value="PREPARING">å•†å“æº–å‚™ä¸­</option><option value="ready">é€šçŸ¥é ˜å–</option><option value="EXCEPTION">ç•°å¸¸é€šçŸ¥</option><option value="End">æ¡ˆä»¶çµæ¡ˆ</option></select>`;
  h+=`<div id="reasonField" style="display:none;margin-top:10px"><textarea id="statusNote" style="width:100%" placeholder="è¼¸å…¥ç•°å¸¸åŸå› ..."></textarea></div>`;
  h+=`<button class="btn btn-success" style="width:100%;margin-top:15px" onclick="updateStatus('${tid}')">ğŸ’¾ å„²å­˜</button>`;
  document.getElementById('orderDetail').innerHTML=h;
  document.getElementById('orderModal').classList.add('show');
  setTimeout(()=>{document.getElementById('newStatus').value=o.status; toggleReason();},0);
}

function toggleReason(){
  const s=document.getElementById('newStatus').value;
  document.getElementById('reasonField').style.display = (s==='EXCEPTION'?'block':'none');
}
  async function updateStatus(tid){
  const s=document.getElementById('newStatus').value, n=document.getElementById('statusNote')?.value;
  if(s==='EXCEPTION' && !n){ alert('è«‹å¡«å¯«ç•°å¸¸åŸå› '); return; }
  
  try{
    await fetch('https://chihwei-n8n.zeabur.app/webhook/update-order', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({task_id:tid, status:s, comment:n, updated_at:new Date().toISOString()})
    });
    alert('âœ… æ›´æ–°æˆåŠŸ'); document.getElementById('orderModal').classList.remove('show'); loadOrders();
  }catch(e){ alert('æ›´æ–°å¤±æ•—'); }
}

function downloadCSV() {
  if (FILTERED_ORDERS.length === 0) { alert('æ²’æœ‰è³‡æ–™å¯ä¸‹è¼‰'); return; }
  let csv = '\uFEFFæ—¥æœŸ,å–®è™Ÿ,ç”³è«‹äºº,å–®ä½,ç‹€æ…‹,é‡‘é¡\n';
  csv += FILTERED_ORDERS.map(o => 
    '"' + formatDate(o.date) + '","' + (o.task_id || '') + '","' + (o.user || '') + '","' + (o.department || '') + '","' + getStatusText(o.status) + '","' + (o.total || 0) + '"'
  ).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'è¨‚å–®å ±è¡¨_' + new Date().toISOString().slice(0, 10) + '.csv';
  link.click();
}
  /* åº«å­˜èˆ‡å•†å“ */
async function loadInventory(){
  const p=document.querySelector('#tab-inventory .panel');
  try{
    const res=await fetch(API_INVENTORY_LIST); const d=await res.json();
    ALL_PRODUCTS=d.items||[];
    renderInventory(ALL_PRODUCTS);
  }catch(e){ p.innerHTML='è¼‰å…¥å¤±æ•—'; }
}

function renderInventory(items) {
  const panel = document.querySelector('#tab-inventory .panel');
  let html = '<table style="width:100%"><thead><tr><th>åœ–</th><th>å“å</th><th>åº«å­˜</th><th>æ“ä½œ</th></tr></thead><tbody>';
  items.forEach(item => {
    const imgHtml = item.image 
      ? `<img src="${item.image}" style="height:40px;cursor:pointer" onclick="showBig('${item.image}')" title="é»æ“Šæ”¾å¤§">` 
      : '<span style="color:#ccc;font-size:12px;">ç„¡åœ–ç‰‡</span>';
    html += `<tr>
      <td style="width:80px;text-align:center;">${imgHtml}</td>
      <td style="font-weight:bold;font-size:15px;">${item.item_name}</td>
      <td style="font-size:16px;color:${item.stock < 10 ? 'red' : 'black'}">${item.stock}</td>
      <td>
        <div style="display:flex;gap:8px;align-items:center;">
          <input type="number" id="stock-${item.item_id}" value="${item.stock}" style="width:60px">
          <button class="btn btn-primary" onclick="updStock('${item.item_id}')">æ›´</button>
        </div>
      </td>
    </tr>`;
  });
  if (!document.getElementById('imgModal')) {
    const modalHtml = `<div id="imgModal" class="modal" onclick="this.style.display='none'"><img id="bigImage" style="max-width:90%;max-height:90%;margin:auto;display:block"></div>`;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
  }
  panel.innerHTML = html + '</tbody></table>';
}

async function updStock(id){
  const v=document.getElementById('stock-'+id).value;
  try{
    await fetch(API_INVENTORY_UPDATE, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({item_id:id, stock:v})});
    alert('å·²æ›´æ–°');
  }catch(e){ alert('å¤±æ•—'); }
}
/* =========================
   3. å•†å“ç®¡ç† (Listing) - v2.0 (å«åˆªé™¤/åº«å­˜/åœ–ç‰‡ä¸Šå‚³)
========================= */
const API_PRODUCT_DELETE = 'https://chihwei-n8n.zeabur.app/webhook/product-delete'; // æ–°å¢åˆªé™¤ API

async function loadListing() {
  const p = document.querySelector('#tab-listing .panel');
  p.innerHTML = '<div style="text-align:right;margin-bottom:10px"><button class="btn btn-success" onclick="editProd()">â• æ–°å¢å•†å“</button></div>';
  try {
    // æ¯æ¬¡éƒ½é‡æ–°æŠ“å–æœ€æ–°è³‡æ–™
    const res = await fetch(API_INVENTORY_LIST); 
    const d = await res.json(); 
    ALL_PRODUCTS = d.items || []; 
    
    let h = '<table style="width:100%"><thead><tr><th>åœ–ç‰‡</th><th>å•†å“ç·¨è™Ÿ</th><th>å“å</th><th>å”®åƒ¹</th><th>åº«å­˜</th><th>æ“ä½œ</th></tr></thead><tbody>';
    ALL_PRODUCTS.forEach(i => {
      h += `<tr>
        <td>${i.image ? `<img src="${i.image}" style="height:50px;width:50px;object-fit:cover;border-radius:4px;">` : '-'}</td>
        <td style="color:#666;">${i.item_id}</td>
        <td style="font-weight:bold;">${i.item_name}</td>
        <td>$${i.unit_price}</td>
        <td>${i.stock}</td>
        <td><button class="btn btn-primary" onclick="editProd('${i.item_id}')">ç·¨è¼¯</button></td>
      </tr>`;
    });
    p.innerHTML += h + '</tbody></table>';
  } catch(e) { p.innerHTML = 'è¼‰å…¥å¤±æ•—'; }
}

function editProd(id) {
  const i = id ? ALL_PRODUCTS.find(x => x.item_id == id) : null;
  const isNew = !i;
  
  // Modal HTML: åŠ å…¥åº«å­˜æ¬„ä½ã€åœ–ç‰‡ç¶²å€å”¯è®€ã€åˆªé™¤æŒ‰éˆ•
  const h = `
  <div id="prodModal" class="modal show" style="display:flex;">
    <div class="modal-body">
      <h3 style="margin-top:0;">${isNew ? 'â• å•†å“ä¸Šæ¶' : 'âœï¸ ç·¨è¼¯å•†å“'}</h3>
      
      <input type="hidden" id="pid" value="${i?.item_id || 'new_' + Math.floor(Date.now()/1000)}">
      
      <label style="display:block;margin:10px 0 5px;font-weight:bold;">å“å</label>
      <input type="text" id="pname" style="width:100%;padding:8px;" value="${i?.item_name || ''}">
      
      <div style="display:flex;gap:10px;">
        <div style="flex:1;">
          <label style="display:block;margin:10px 0 5px;font-weight:bold;">å”®åƒ¹</label>
          <input type="number" id="pprice" style="width:100%;padding:8px;" value="${i?.unit_price || ''}">
        </div>
        <div style="flex:1;">
          <label style="display:block;margin:10px 0 5px;font-weight:bold;">åº«å­˜é‡</label>
          <input type="number" id="pstock" style="width:100%;padding:8px;" value="${i?.stock || '0'}">
        </div>
      </div>

      <label style="display:block;margin:10px 0 5px;font-weight:bold;">å•†å“åœ–ç‰‡</label>
      <div style="display:flex;gap:8px;align-items:center;">
        <!-- ç¶²å€æ¬„ä½è¨­ç‚º readonly (å”¯è®€)ï¼ŒèƒŒæ™¯ç°è‰² -->
        <input type="text" id="pimg" style="flex:1;padding:8px;background:#f5f5f5;color:#666;" placeholder="è«‹ä½¿ç”¨å³å´æŒ‰éˆ•ä¸Šå‚³..." value="${i?.image || ''}" readonly>
        <label class="btn btn-outline" style="cursor:pointer;white-space:nowrap;">
          ğŸ“¤ ä¸Šå‚³
          <input type="file" hidden onchange="upImg(this)">
        </label>
      </div>
      <div id="upStatus" style="font-size:12px;color:#666;margin-top:4px;min-height:20px;"></div>

      <div style="margin-top:20px;text-align:right;border-top:1px solid #eee;padding-top:15px;display:flex;justify-content:space-between;">
        <!-- å·¦å´ï¼šåˆªé™¤æŒ‰éˆ• (åªæœ‰ç·¨è¼¯æ¨¡å¼æ‰é¡¯ç¤º) -->
        <div>
          ${!isNew ? `<button class="btn btn-danger" onclick="delProd('${id}')">ğŸ—‘ï¸ ä¸‹æ¶ç§»é™¤</button>` : ''}
        </div>
        <!-- å³å´ï¼šå–æ¶ˆèˆ‡å„²å­˜ -->
        <div style="display:flex;gap:10px;">
          <button class="btn btn-outline" onclick="this.closest('.modal').remove()">å–æ¶ˆ</button> 
          <button class="btn btn-success" onclick="saveProd()">å„²å­˜</button>
        </div>
      </div>
    </div>
  </div>`;
  
  document.body.insertAdjacentHTML('beforeend', h);
}

async function upImg(inp) {
  const f = inp.files[0]; if (!f) return;
  const stat = document.getElementById('upStatus');
  
  const reader = new FileReader();
  reader.onload = function(e) {
    // å°‡ Base64 è³‡æ–™æš«å­˜åœ¨ pimg æ¬„ä½ä¸­ï¼Œä¸å³æ™‚ä¸Šå‚³
    document.getElementById('pimg').value = e.target.result;
    stat.innerHTML = `<span style="color:blue">ğŸ“¸ åœ–ç‰‡å·²é¸å–ï¼ˆå„²å­˜å¾Œæ­£å¼ä¸Šå‚³ï¼‰</span>`;
  };
  reader.readAsDataURL(f);
  inp.value = ''; 
}

async function saveProd() {
  const id = document.getElementById('pid').value;
  const name = document.getElementById('pname').value;
  const price = document.getElementById('pprice').value;
  const stock = document.getElementById('pstock').value;
  const imgData = document.getElementById('pimg').value; // é€™å¯èƒ½æ˜¯èˆŠé€£çµæˆ–æ–° Base64

  if (!name || !price) { alert('å“åèˆ‡å”®åƒ¹ç‚ºå¿…å¡«'); return; }

  const btn = event.target; btn.disabled = true; btn.textContent = 'è™•ç†ä¸­...';

  try {
    // åˆ¤æ–·æ˜¯å¦ç‚ºæ–°é¸æ“‡çš„åœ–ç‰‡ (Base64)
    const isNewImage = imgData.startsWith('data:image');

    await fetch(API_PRODUCT_SAVE, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        item_id: id,
        item_name: name,
        unit_price: price,
        stock: stock,
        // å¦‚æœæ˜¯æ–°åœ–ï¼Œå‚³é€ Base64 çµ¦å¾Œç«¯ä¸Šå‚³ï¼›å¦‚æœæ˜¯èˆŠåœ–ï¼Œå‚³é€åŸæœ¬ç¶²å€
        image_data: isNewImage ? imgData.split(',')[1] : null, 
        image_url: isNewImage ? null : imgData
      })
    });
    alert('âœ… å•†å“è³‡æ–™èˆ‡åœ–ç‰‡å·²å„²å­˜');
    document.getElementById('prodModal').remove();
    loadListing();
  } catch (e) { alert('âŒ å¤±æ•—'); console.error(e); } 
  finally { btn.disabled = false; }
}

async function delProd(id) {
  if (!confirm('âš ï¸ ç¢ºå®šè¦å°‡æ­¤å•†å“ä¸‹æ¶ç§»é™¤å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) return;
  
  try {
    await fetch(API_PRODUCT_DELETE, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ item_id: id })
    });
    alert('ğŸ—‘ï¸ å•†å“å·²ä¸‹æ¶');
    document.getElementById('prodModal').remove();
    loadListing();
  } catch (e) { alert('ç§»é™¤å¤±æ•—'); }
}

function showBig(src){
  const m = document.getElementById('imgModal');
  if(m) {
    m.querySelector('img').src = src;
    m.style.display = 'flex';
  }
}

function closeModal(){document.getElementById('orderModal').classList.remove('show');}
document.getElementById('orderModal').addEventListener('click',function(e){if(e.target===this)closeModal();});
window.onload=function(){ loadOrders(); };
</script>
</body>
</html>
