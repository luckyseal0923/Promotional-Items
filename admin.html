<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å…¬é—œå“å¾Œè‡ºç®¡ç†ç³»çµ±</title>
<style>
:root {
  --primary: #10B981;
  --primary-dark: #059669;
  --bg: #F8FAFC;
  --text: #334155;
  --border: #E2E8F0;
  --danger: #EF4444;
  --warning: #F59E0B;
}
body,html{margin:0;height:100%;font-family:"PingFang TC",sans-serif;background:var(--bg);color:var(--text)}
.hidden{display:none!important}
.sidebar{width:260px;background:#fff;height:100vh;position:fixed;padding:24px;border-right:1px solid var(--border);box-sizing:border-box;z-index:100}
.main-content{margin-left:260px;padding:30px}
@media (max-width: 900px) {
  .sidebar{width:70px;padding:15px 5px;text-align:center}
  .sidebar h2,.sidebar .nav-text{display:none}
  .main-content{margin-left:70px;padding:15px}
}
.nav-item{padding:14px 18px;border-radius:10px;margin-bottom:8px;cursor:pointer;color:#64748B;display:flex;align-items:center;gap:12px;transition:0.2s}
.nav-item.active{background:var(--primary);color:#fff;font-weight:bold}
.panel{background:#fff;border-radius:12px;padding:24px;border:1px solid var(--border);margin-bottom:24px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
h1{font-size:22px;border-left:5px solid var(--primary);padding-left:14px;margin-bottom:24px;color:#0F172A}
table{width:100%;border-collapse:collapse;min-width:800px}
th{text-align:left;padding:12px;background:#F8FAFC;border-bottom:2px solid var(--border);font-size:13px}
td{padding:16px 12px;border-bottom:1px solid var(--border);font-size:14px}
.table-wrapper{overflow-x:auto}
.btn{padding:10px 16px;border-radius:8px;border:none;cursor:pointer;font-size:13px;font-weight:600;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:var(--primary);color:#fff}
.btn-success{background:#10B981;color:#fff}
.btn-outline{background:#fff;border:1px solid var(--border);color:var(--text)}
.btn-danger{background:var(--danger);color:#fff}
.status-pill{padding:4px 10px;border-radius:6px;font-size:12px;font-weight:bold}
.status-preparing{background:#DBEAFE;color:#1E40AF}
.status-submitted{background:#FEF3C7;color:#92400E}
.status-ready{background:#D1FAE5;color:#065F46}
.status-exception{background:#FEE2E2;color:#991B1B}
.status-end{background:#E5E7EB;color:#374151}
input,select{padding:12px;border:1px solid var(--border);border-radius:8px;outline:none;box-sizing:border-box;font-size:14px}
input:focus,select:focus{border-color:var(--primary)}
.modal{position:fixed;inset:0;background:rgba(15,23,42,0.5);display:none;align-items:center;justify-content:center;z-index:5000;padding:15px}
.modal.show{display:flex}
.modal-body{background:#fff;padding:30px;border-radius:16px;width:100%;max-width:550px;max-height:90vh;overflow-y:auto}
.modal-title{margin:0 0 20px 0;font-size:18px;color:#0F172A}
.info-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px dashed #E2E8F0}
.info-label{color:#64748B;font-size:14px}
.info-value{font-weight:600;font-size:14px}
.item-list{background:#F8FAFC;padding:12px;border-radius:8px;margin:10px 0}
.item-row{display:flex;justify-content:space-between;padding:6px 0}
</style>
</head>
<body>
<div id="adminView">
  <div class="sidebar">
    <h2 style="color:var(--primary-dark);margin-bottom:30px">å…¬é—œå“å¾Œè‡º</h2>
    <div class="nav-item active" id="nav-orders" onclick="switchTab('orders')">ğŸ“‹ <span class="nav-text">è¨‚å–®ç®¡ç†ç³»çµ±</span></div>
    <div class="nav-item" id="nav-inventory" onclick="switchTab('inventory')">âš–ï¸ <span class="nav-text">åº«å­˜ç›¤é»</span></div>
    <div class="nav-item" id="nav-listing" onclick="switchTab('listing')">ğŸš€ <span class="nav-text">å•†å“ç®¡ç†</span></div>
    <div class="nav-item" id="nav-accounts" onclick="switchTab('accounts')">ğŸ‘¥ <span class="nav-text">å¸³è™Ÿç®¡ç†</span></div>
    <div style="margin-top:50px"><button class="btn btn-outline" style="width:100%">å®‰å…¨ç™»å‡º</button></div>
  </div>
  <div class="main-content">
    <div id="tab-orders">
      <h1>è¨‚å–®ç®¡ç†ç³»çµ±</h1>
      <div id="orderError" class="hidden" style="padding:14px;border-radius:10px;background:#FEE2E2;color:#991B1B;font-weight:bold;margin-bottom:16px">âš ï¸ è¨‚å–®è³‡æ–™ç›®å‰ç„¡æ³•è¼‰å…¥ï¼Œè«‹ç¨å¾Œå†è©¦</div>
      <div class="panel">
        <div style="display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;align-items:center">
          <input type="date" id="dateFrom" onchange="filterOrders()">
          <span>è‡³</span>
          <input type="date" id="dateTo" onchange="filterOrders()">
          <select id="statusFilter" onchange="filterOrders()" style="min-width:120px">
            <option value="">å…¨éƒ¨ç‹€æ…‹</option>
            <option value="Submitted">ç”³è«‹æå‡º</option>
            <option value="PREPARING">å•†å“æº–å‚™ä¸­</option>
            <option value="ready">é€šçŸ¥é ˜å–</option>
            <option value="EXCEPTION">ç•°å¸¸é€šçŸ¥</option>
            <option value="End">æ¡ˆä»¶çµæ¡ˆ</option>
          </select>
<input type="text" id="searchKeyword" placeholder="æœå°‹å–®è™Ÿ/ç”³è«‹äºº" style="width:150px">
<button class="btn btn-primary" onclick="filterOrders()">ğŸ” ç¯©é¸</button>
<button class="btn btn-outline" onclick="resetFilter()">é‡ç½®</button>
<button class="btn btn-success" onclick="downloadCSV()">ğŸ“¥ ä¸‹è¼‰å ±è¡¨</button>
        </div>
        <div class="table-wrapper">
          <table>
            <<thead><tr><th>æ—¥æœŸ / å–®è™Ÿ</th><th>ç”³è«‹äºº</th><th>å–®ä½</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="orderTable"><tr><td colspan="5" style="text-align:center;color:#666;padding:30px">è¼‰å…¥ä¸­...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
    <div id="tab-inventory" class="hidden"><h1>åº«å­˜ç›¤é»</h1><div class="panel">ï¼ˆåŠŸèƒ½é–‹ç™¼ä¸­ï¼‰</div></div>
    <div id="tab-listing" class="hidden"><h1>å•†å“ç®¡ç†</h1><div class="panel">ï¼ˆåŠŸèƒ½é–‹ç™¼ä¸­ï¼‰</div></div>
    <div id="tab-accounts" class="hidden"><h1>å¸³è™Ÿç®¡ç†</h1><div class="panel">ï¼ˆåŠŸèƒ½é–‹ç™¼ä¸­ï¼‰</div></div>
  </div>
</div>
<div id="orderModal" class="modal">
  <div class="modal-body">
    <h3 class="modal-title">ğŸ“‹ è¨‚å–®è©³ç´°è³‡è¨Š</h3>
    <div id="orderDetail"></div>
    <button class="btn btn-primary" style="width:100%;margin-top:20px" onclick="closeModal()">é—œé–‰</button>
  </div>
</div>

<script>
const API_ORDERS = 'https://chihwei-n8n.zeabur.app/webhook/orders';
const API_INVENTORY_LIST = 'https://chihwei-n8n.zeabur.app/webhook/inventory-list';
const API_INVENTORY_UPDATE = 'https://chihwei-n8n.zeabur.app/webhook/inventory-update';
// ğŸ”¥ æ–°å¢é€™å…©è¡Œï¼šå•†å“å„²å­˜èˆ‡åœ–ç‰‡ä¸Šå‚³
const API_PRODUCT_SAVE = 'https://chihwei-n8n.zeabur.app/webhook/product-save';
const API_PRODUCT_UPLOAD = 'https://chihwei-n8n.zeabur.app/webhook/product-upload-image';
  
let ALL_ORDERS = [];
let FILTERED_ORDERS = [];

const STATUS_MAP = {
  'Submitted':'ç”³è«‹æå‡º','PREPARING':'å•†å“æº–å‚™ä¸­','preparing':'å•†å“æº–å‚™ä¸­',
  'ready':'é€šçŸ¥é ˜å–','EXCEPTION':'ç•°å¸¸é€šçŸ¥','End':'æ¡ˆä»¶çµæ¡ˆ','done':'æ¡ˆä»¶çµæ¡ˆ','closed':'æ¡ˆä»¶çµæ¡ˆ'
};
const STATUS_CLASS_MAP = {
  'Submitted':'status-submitted','PREPARING':'status-preparing','preparing':'status-preparing',
  'ready':'status-ready','EXCEPTION':'status-exception','End':'status-end','done':'status-end','closed':'status-end'
};

function getStatusText(s){return STATUS_MAP[s]||s||'æœªçŸ¥';}
function getStatusClass(s){return STATUS_CLASS_MAP[s]||'status-preparing';}
function formatDate(d) {
  if (!d) return '-';
  const n = new Date(d);
  if (isNaN(n)) return d;
  return n.toLocaleDateString('zh-TW');
}
function formatDateTime(d){if(!d)return'-';const n=new Date(d);return isNaN(n)?d:n.toLocaleString('zh-TW');}

function switchTab(tab) {
  // 1. å…ˆéš±è—æ‰€æœ‰åˆ†é ï¼Œç§»é™¤æ‰€æœ‰ active æ¨£å¼
  ['orders','inventory','listing','accounts'].forEach(t => {
    document.getElementById('tab-' + t).classList.add('hidden');
    document.getElementById('nav-' + t).classList.remove('active');
  });
  
  // 2. é¡¯ç¤ºç›®å‰é¸åˆ°çš„åˆ†é ï¼ŒåŠ ä¸Š active æ¨£å¼
  document.getElementById('tab-' + tab).classList.remove('hidden');
  document.getElementById('nav-' + tab).classList.add('active');

  // ğŸ”¥ æ–°å¢ï¼šæ ¹æ“šåˆ‡æ›çš„åˆ†é ï¼Œè‡ªå‹•è¼‰å…¥å°æ‡‰è³‡æ–™
  if (tab === 'inventory') {
    loadInventory(); // è¼‰å…¥åº«å­˜
  } else if (tab === 'listing') {
    loadListing();   // è¼‰å…¥å•†å“åˆ—è¡¨ (é€™æ˜¯æ–°å¢çš„!)
  }
}
  document.getElementById('tab-'+tab).classList.remove('hidden');
  document.getElementById('nav-'+tab).classList.add('active');
    // å¦‚æœåˆ‡æ›åˆ°åº«å­˜é ï¼Œè‡ªå‹•è¼‰å…¥è³‡æ–™
  if(tab === 'inventory') {
    loadInventory();
  }
}
/* === åº«å­˜ç›¤é»ç³»çµ± === */
async function loadInventory() {
  const panel = document.querySelector('#tab-inventory .panel');
  panel.innerHTML = '<p style="text-align:center;color:#666;">è¼‰å…¥åº«å­˜ä¸­...</p>';
  
  try {
    const res = await fetch(API_INVENTORY_LIST);
    const data = await res.json();
    renderInventory(data.items || []);
  } catch(e) {
    console.error(e);
    panel.innerHTML = '<p style="color:red;text-align:center;">è¼‰å…¥å¤±æ•—</p>';
  }
}

function renderInventory(items) {
  const panel = document.querySelector('#tab-inventory .panel');
  let html = '<table style="width:100%"><thead><tr><th>åœ–ç‰‡</th><th>å“å</th><th>ç›®å‰åº«å­˜</th><th>ç›¤é»æ“ä½œ</th></tr></thead><tbody>';
  
  items.forEach(item => {
    // 1. åœ–ç‰‡åŠ å¤§ï¼šå¾åŸæœ¬çš„ 40px åŠ å¤§åˆ° 60px
    // 2. é»æ“Šæ”¾å¤§ï¼šåŠ å…¥ onclick="showBigImage(...)"
    const imgHtml = item.image 
      ? `<img src="${item.image}" style="height:60px;width:60px;object-fit:cover;border-radius:6px;cursor:pointer;border:1px solid #ddd;" onclick="showBigImage('${item.image}')" title="é»æ“Šæ”¾å¤§">` 
      : '<span style="color:#ccc;font-size:12px;">ç„¡åœ–ç‰‡</span>';

    html += `<tr>
      <td style="width:80px;text-align:center;">${imgHtml}</td>
      <td style="font-weight:bold;font-size:15px;">${item.item_name}</td>
      <td style="font-size:16px;color:${item.stock < 10 ? 'red' : 'black'}">${item.stock}</td>
      <td>
        <div style="display:flex;gap:8px;align-items:center;">
          <input type="number" id="stock-${item.item_id}" value="${item.stock}" style="width:80px;padding:8px;border-radius:6px;border:1px solid #ddd;">
          <button class="btn btn-primary" onclick="updateStock('${item.item_id}')">æ›´æ–°</button>
        </div>
      </td>
    </tr>`;
  });
  html += '</tbody></table>';
  
  // ğŸ”¥ æ–°å¢ï¼šå¤§åœ–é è¦½ Modal (åªæ’å…¥ä¸€æ¬¡)
  if (!document.getElementById('imgModal')) {
const modalHtml = `
  <div id="productModal" class="modal">
    <div class="modal-body">
      <h3 id="modalTitle" class="modal-title">ç·¨è¼¯å•†å“</h3>
      <input type="hidden" id="p_id">
      
      <label style="display:block;margin-bottom:8px;">å•†å“åç¨±</label>
      <input type="text" id="p_name" style="width:100%;margin-bottom:16px;padding:8px;">
      
      <label style="display:block;margin-bottom:8px;">å–®åƒ¹</label>
      <input type="number" id="p_price" style="width:100%;margin-bottom:16px;padding:8px;">
      
      <label style="display:block;margin-bottom:8px;">å•†å“åœ–ç‰‡</label>
      <div style="display:flex;gap:10px;margin-bottom:16px;">
        <input type="text" id="p_image" style="flex:1;padding:8px;" placeholder="åœ–ç‰‡ç¶²å€...">
        <!-- ä¸Šå‚³æŒ‰éˆ• -->
        <label class="btn btn-outline" style="cursor:pointer;">
          ğŸ“¤ ä¸Šå‚³
          <input type="file" id="p_file" style="display:none;" onchange="uploadImage(this)">
        </label>
      </div>
      <div id="uploadStatus" style="font-size:12px;color:#666;margin-bottom:10px;"></div>
      
      <div style="display:flex;gap:10px;justify-content:flex-end;border-top:1px solid #eee;padding-top:16px;">
        <button class="btn btn-outline" onclick="document.getElementById('productModal').classList.remove('show')">å–æ¶ˆ</button>
        <button class="btn btn-success" onclick="saveProduct()">å„²å­˜</button>
      </div>
    </div>
  </div>
`;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
  }
  
  panel.innerHTML = html;
}

// ğŸ”¥ æ–°å¢ï¼šæ§åˆ¶å¤§åœ–é¡¯ç¤ºçš„å‡½å¼
function showBigImage(src) {
  const modal = document.getElementById('imgModal');
  const img = document.getElementById('bigImage');
  img.src = src;
  modal.style.display = 'flex'; // é¡¯ç¤º Modal
}

function closeBigImage() {
  document.getElementById('imgModal').style.display = 'none'; // éš±è— Modal
}

async function updateStock(itemId) {
  const input = document.getElementById(`stock-${itemId}`);
  const newStock = input.value;
  const btn = event.target;
  
  btn.disabled = true;
  btn.textContent = '...';
  
  try {
    const res = await fetch(API_INVENTORY_UPDATE, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ item_id: itemId, stock: newStock })
    });
    const data = await res.json();
    if(data.success) {
      alert('âœ… åº«å­˜å·²æ›´æ–°');
      loadInventory(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
    } else {
      alert('âŒ æ›´æ–°å¤±æ•—');
    }
  } catch(e) {
    alert('é€£ç·šéŒ¯èª¤');
  } finally {
    btn.disabled = false;
    btn.textContent = 'æ›´æ–°';
  }
}
  
async function loadOrders(){
  try{
    const res=await fetch(API_ORDERS);
    if(!res.ok)throw new Error('API error');
    const data=await res.json();
    ALL_ORDERS=[...(data.orders?.active||[]),...(data.orders?.archived||[])];
    FILTERED_ORDERS=[...ALL_ORDERS];
    console.log('è¼‰å…¥è¨‚å–®æˆåŠŸ:',ALL_ORDERS.length,'ç­†');
    document.getElementById('orderError').classList.add('hidden');
    renderOrders();
  }catch(e){
    console.warn('è¨‚å–®è¼‰å…¥å¤±æ•—',e);
    document.getElementById('orderError').classList.remove('hidden');
    document.getElementById('orderTable').innerHTML='<tr><td colspan="6" style="text-align:center;color:#991B1B;padding:30px">è¼‰å…¥å¤±æ•—</td></tr>';
  }
}

function downloadCSV() {
  if (FILTERED_ORDERS.length === 0) { alert('æ²’æœ‰è³‡æ–™å¯ä¸‹è¼‰'); return; }
  let csv = '\uFEFFæ—¥æœŸ,å–®è™Ÿ,ç”³è«‹äºº,å–®ä½,ç‹€æ…‹,é‡‘é¡\n';
  csv += FILTERED_ORDERS.map(o => 
    '"' + formatDate(o.date) + '","' + (o.task_id || '') + '","' + (o.user || '') + '","' + (o.department || '') + '","' + getStatusText(o.status) + '","' + (o.total || 0) + '"'
  ).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'è¨‚å–®å ±è¡¨_' + new Date().toISOString().slice(0, 10) + '.csv';
  link.click();
}    

function filterOrders() {
  const df = document.getElementById('dateFrom').value;
  const dt = document.getElementById('dateTo').value;
  const sf = document.getElementById('statusFilter').value;
  const kw = document.getElementById('searchKeyword').value.toLowerCase().trim();
  
  FILTERED_ORDERS = ALL_ORDERS.filter(o => {
    if (df || dt) {
      const od = o.date ? new Date(o.date).toISOString().split('T')[0] : '';
      if (df && od < df) return false;
      if (dt && od > dt) return false;
    }
    if (sf && o.status !== sf) return false;
    if (kw) {
      const matchId = (o.task_id || '').toLowerCase().includes(kw);
      const matchUser = (o.user || '').toLowerCase().includes(kw);
      if (!matchId && !matchUser) return false;
    }
    return true;
  });
  renderOrders();
}

function resetFilter() {
  document.getElementById('dateFrom').value = '';
  document.getElementById('dateTo').value = '';
  document.getElementById('statusFilter').value = '';
  document.getElementById('searchKeyword').value = '';
  FILTERED_ORDERS = [...ALL_ORDERS];
  renderOrders();
}

function renderOrders() {
  const tb = document.getElementById('orderTable');
  if (FILTERED_ORDERS.length === 0) {
    tb.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#666;padding:30px">å°šç„¡è¨‚å–®è³‡æ–™</td></tr>';
    return;
  }
  tb.innerHTML = FILTERED_ORDERS.map(o =>
    '<tr>' +
      '<td style="line-height:1.5;width:140px">' +
        '<div style="font-size:14px;font-weight:600;color:#0F172A">' + formatDate(o.date) + '</div>' +
        '<div style="font-size:11px;color:#94A3B8">' + (o.task_id || '-') + '</div>' +
      '</td>' +
      '<td>' + (o.user || '-') + '</td>' +
      '<td>' + (o.department || '-') + '</td>' +
      '<td><span class="status-pill ' + getStatusClass(o.status) + '">' + getStatusText(o.status) + '</span></td>' +
      '<td style="white-space:nowrap">' +
        '<button class="btn btn-outline" style="margin-right:4px" onclick="showOrderDetail(\'' + o.task_id + '\')">ğŸ“‹ æŸ¥è©¢</button>' +
        '<button class="btn btn-primary" onclick="showEditStatus(\'' + o.task_id + '\')">âœï¸ ç‹€æ…‹</button>' +
      '</td>' +
    '</tr>'
  ).join('');
}

function showOrderDetail(tid) {
  const o = ALL_ORDERS.find(x => x.task_id === tid);
  if (!o) { alert('æ‰¾ä¸åˆ°æ­¤è¨‚å–®'); return; }
  
  let ih = o.items && o.items.length > 0 
    ? o.items.map(i => '<div class="item-row"><span>' + (i.item_name || i.name || 'æœªçŸ¥å•†å“') + '</span><span>x' + (i.quantity || i.qty || 1) + ' / $' + (i.subtotal || 0) + '</span></div>').join('') 
    : '<p style="color:#666">ç„¡å•†å“æ˜ç´°</p>';
  
  let dh = '<div style="background:#F8FAFC;padding:16px;border-radius:10px;margin-bottom:16px">';
  dh += '<div class="info-row"><span class="info-label">è¨‚å–®ç·¨è™Ÿ</span><span class="info-value">' + (o.task_id || '-') + '</span></div>';
  dh += '<div class="info-row"><span class="info-label">ç”³è«‹æ™‚é–“</span><span class="info-value">' + formatDateTime(o.date) + '</span></div>';
  dh += '<div class="info-row"><span class="info-label">ç”³è«‹äºº</span><span class="info-value">' + (o.user || '-') + '</span></div>';
  dh += '<div class="info-row"><span class="info-label">é™¢å…§å“¡ç·¨</span><span class="info-value">' + (o.staff_id || '-') + '</span></div>';
  dh += '<div class="info-row"><span class="info-label">ç”³è«‹è€…é›»è©±</span><span class="info-value">' + (o.phone || '-') + '</span></div>';
  dh += '<div class="info-row"><span class="info-label">é›»å­ä¿¡ç®±</span><span class="info-value">' + (o.email || '-') + '</span></div>';
  dh += '<div class="info-row"><span class="info-label">ç”³è«‹å–®ä½</span><span class="info-value">' + (o.department || '-') + '</span></div>';
  dh += '<div class="info-row"><span class="info-label">æˆæœ¬ä¸­å¿ƒ</span><span class="info-value">' + (o.cost_center || '-') + '</span></div>';
  dh += '<div class="info-row"><span class="info-label">ç”³è«‹äº‹ç”±</span><span class="info-value">' + (o.reason || '-') + '</span></div>';
  dh += '<div class="info-row"><span class="info-label">è¨‚å–®ç‹€æ…‹</span><span class="info-value"><span class="status-pill ' + getStatusClass(o.status) + '">' + getStatusText(o.status) + '</span></span></div>';

  // ğŸ”¥ ç•°å¸¸åŸå› é¡¯ç¤ºå€å¡Š (æ–°å¢)
  if (o.status === 'EXCEPTION' && o.comment) {
    dh += '<div style="margin:10px 0;padding:12px;background:#FEF2F2;border-left:4px solid #EF4444;border-radius:4px;">';
    dh += '<strong style="color:#991B1B;display:block;margin-bottom:4px;font-size:13px;">ğŸ”´ ç•°å¸¸åŸå› ï¼š</strong>';
    dh += '<span style="color:#7F1D1D;font-weight:bold;">' + o.comment + '</span>';
    dh += '</div>';
  }

  dh += '<div class="info-row"><span class="info-label">è¨‚å–®é‡‘é¡</span><span class="info-value" style="color:var(--primary)">$' + (o.total || 0) + '</span></div>';
  dh += '</div><h4 style="margin:16px 0 8px 0;color:#0F172A">ğŸ“¦ å•†å“æ˜ç´°</h4><div class="item-list">' + ih + '</div>';
  
  document.getElementById('orderDetail').innerHTML = dh;
  document.getElementById('orderModal').classList.add('show');
}

function showEditStatus(tid) {
  const o = ALL_ORDERS.find(x => x.task_id === tid);
  if (!o) { alert('æ‰¾ä¸åˆ°æ­¤è¨‚å–®'); return; }
  
  let dh = '<div style="margin-bottom:16px">';
  dh += '<div class="info-row"><span class="info-label">è¨‚å–®ç·¨è™Ÿ</span><span class="info-value">' + (o.task_id || '-') + '</span></div>';
  dh += '<div class="info-row"><span class="info-label">ç›®å‰ç‹€æ…‹</span><span class="info-value"><span class="status-pill ' + getStatusClass(o.status) + '">' + getStatusText(o.status) + '</span></span></div>';
  dh += '</div>';
  
  dh += '<label style="font-size:14px;font-weight:600;margin-bottom:8px;display:block">è®Šæ›´ç‚ºï¼š</label>';
  dh += '<select id="newStatus" style="width:100%" onchange="toggleReasonField()">';
  dh += '<option value="Submitted"' + (o.status === 'Submitted' ? ' selected' : '') + '>ç”³è«‹æå‡º</option>';
  dh += '<option value="PREPARING"' + (o.status === 'PREPARING' ? ' selected' : '') + '>å•†å“æº–å‚™ä¸­</option>';
  dh += '<option value="ready"' + (o.status === 'ready' ? ' selected' : '') + '>é€šçŸ¥é ˜å–</option>';
  dh += '<option value="EXCEPTION"' + (o.status === 'EXCEPTION' ? ' selected' : '') + '>ç•°å¸¸é€šçŸ¥ (éœ€å¡«åŸå› )</option>';
  dh += '<option value="End"' + (o.status === 'End' ? ' selected' : '') + '>æ¡ˆä»¶çµæ¡ˆ</option>';
  dh += '</select>';
  
  // ç•°å¸¸åŸå› è¼¸å…¥æ¡†
  dh += '<div id="reasonField" style="display:none; margin-top:12px;">';
  dh += '<label style="color:#EF4444;font-size:13px;font-weight:bold;margin-bottom:4px;display:block">ç•°å¸¸åŸå›  (å¿…å¡«)ï¼š</label>';
  dh += '<textarea id="statusNote" rows="3" style="width:100%;padding:8px;border:1px solid #EF4444;border-radius:6px;" placeholder="è«‹èªªæ˜ç•°å¸¸åŸå› ..."></textarea>';
  dh += '</div>';
  
  dh += '<button class="btn btn-success" style="width:100%;margin-top:16px" onclick="updateStatus(\'' + tid + '\')">ğŸ’¾ å„²å­˜è®Šæ›´</button>';
  
  document.getElementById('orderDetail').innerHTML = dh;
  document.getElementById('orderModal').classList.add('show');
  
  toggleReasonField(); // åˆå§‹åŒ–
}

function toggleReasonField() {
  const status = document.getElementById('newStatus').value;
  const reasonDiv = document.getElementById('reasonField');
  if (status === 'EXCEPTION') {
    reasonDiv.style.display = 'block';
  } else {
    reasonDiv.style.display = 'none';
  }
}

function updateStatus(tid) {
  const newStatus = document.getElementById('newStatus').value;
  const note = document.getElementById('statusNote') ? document.getElementById('statusNote').value.trim() : '';
  const btn = event.target;
  
  if (newStatus === 'EXCEPTION' && !note) {
    alert('âŒ è«‹å¡«å¯«ç•°å¸¸åŸå› ï¼');
    document.getElementById('statusNote').focus();
    return;
  }
  
  btn.disabled = true;
  btn.textContent = 'è™•ç†ä¸­...';
  
  fetch('https://chihwei-n8n.zeabur.app/webhook/update-order', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      task_id: tid,
      status: newStatus,
      comment: note,
      updated_at: new Date().toISOString()
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert('âœ… ç‹€æ…‹å·²æ›´æ–°');
      closeModal();
      loadOrders();
    } else {
      alert('âŒ æ›´æ–°å¤±æ•—ï¼š' + (data.message || 'æœªçŸ¥éŒ¯èª¤'));
    }
  })
  .catch(e => {
    alert('âŒ é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
    console.error(e);
  })
  .finally(() => {
    btn.disabled = false;
    btn.textContent = 'ğŸ’¾ å„²å­˜è®Šæ›´';
  });
}

function closeModal(){document.getElementById('orderModal').classList.remove('show');}
document.getElementById('orderModal').addEventListener('click',function(e){if(e.target===this)closeModal();});
/* === å•†å“ç®¡ç†ç³»çµ± (Listing) === */
const API_PRODUCT_SAVE = 'https://chihwei-n8n.zeabur.app/webhook/product-save';
// const API_PRODUCT_DELETE = '...'; // æš«æ™‚ä¸éœ€è¦

let ALL_PRODUCTS = []; // æš«å­˜å•†å“åˆ—è¡¨

async function loadListing() {
  const panel = document.querySelector('#tab-listing .panel');
  panel.innerHTML = '<p style="text-align:center;color:#666;">è¼‰å…¥å•†å“ä¸­...</p>';
  
  try {
    // é‡ç”¨ inventory-list çš„ API ä¾†æŠ“å•†å“è³‡æ–™
    const res = await fetch(API_INVENTORY_LIST);
    const data = await res.json();
    ALL_PRODUCTS = data.items || [];
    renderListing(ALL_PRODUCTS);
  } catch(e) {
    console.error(e);
    panel.innerHTML = '<p style="color:red;text-align:center;">è¼‰å…¥å¤±æ•—</p>';
  }
}

function renderListing(items) {
  const panel = document.querySelector('#tab-listing .panel');
  let html = '<div style="margin-bottom:16px;text-align:right;"><button class="btn btn-success" onclick="editProduct()">â• æ–°å¢å•†å“</button></div>';
  
  html += '<table style="width:100%"><thead><tr><th>åœ–ç‰‡</th><th>ID</th><th>å“å</th><th>å–®åƒ¹</th><th>æ“ä½œ</th></tr></thead><tbody>';
  
  items.forEach(item => {
    html += `<tr>
      <td>${item.image ? `<img src="${item.image}" style="height:40px;border-radius:4px;">` : '-'}</td>
      <td style="font-size:12px;color:#666;">${item.item_id}</td>
      <td style="font-weight:bold;">${item.item_name}</td>
      <td>$${item.unit_price}</td>
      <td>
        <button class="btn btn-primary" onclick="editProduct('${item.item_id}')">âœï¸ ç·¨è¼¯</button>
      </td>
    </tr>`;
  });
  html += '</tbody></table>';
  
  // æ’å…¥ç·¨è¼¯ Modal (åªæ’ä¸€æ¬¡)
    if (!document.getElementById('productModal')) {
    const modalHtml = `
      <div id="productModal" class="modal">
        <div class="modal-body">
          <h3 id="modalTitle" class="modal-title">ç·¨è¼¯å•†å“</h3>
          <input type="hidden" id="p_id">
          
          <label style="display:block;margin-bottom:8px;">å•†å“åç¨±</label>
          <input type="text" id="p_name" style="width:100%;margin-bottom:16px;padding:8px;border:1px solid #ddd;border-radius:4px;">
          
          <label style="display:block;margin-bottom:8px;">å–®åƒ¹</label>
          <input type="number" id="p_price" style="width:100%;margin-bottom:16px;padding:8px;border:1px solid #ddd;border-radius:4px;">
          
          <label style="display:block;margin-bottom:8px;">å•†å“åœ–ç‰‡</label>
          <div style="display:flex;gap:10px;margin-bottom:8px;">
            <input type="text" id="p_image" style="flex:1;padding:8px;border:1px solid #ddd;border-radius:4px;" placeholder="åœ–ç‰‡ç¶²å€...">
            <!-- ä¸Šå‚³æŒ‰éˆ• -->
            <label class="btn btn-outline" style="cursor:pointer;display:flex;align-items:center;">
              ğŸ“¤ ä¸Šå‚³
              <input type="file" id="p_file" style="display:none;" onchange="uploadImage(this)">
            </label>
          </div>
          <!-- ä¸Šå‚³ç‹€æ…‹é¡¯ç¤º -->
          <div id="uploadStatus" style="font-size:12px;color:#666;margin-bottom:16px;height:20px;"></div>
          
          <div style="display:flex;gap:10px;justify-content:flex-end;border-top:1px solid #eee;padding-top:16px;">
            <button class="btn btn-outline" onclick="document.getElementById('productModal').classList.remove('show')">å–æ¶ˆ</button>
            <button class="btn btn-success" onclick="saveProduct()">å„²å­˜</button>
          </div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
  }
  
  panel.innerHTML = html;
}

function editProduct(itemId) {
  const modal = document.getElementById('productModal');
  const title = document.getElementById('modalTitle');
  
  if (itemId) {
    // ç·¨è¼¯æ¨¡å¼
    const item = ALL_PRODUCTS.find(x => x.item_id == itemId); // æ³¨æ„è½‰å‹
    if (!item) return;
    
    title.textContent = 'âœï¸ ç·¨è¼¯å•†å“';
    document.getElementById('p_id').value = item.item_id;
    document.getElementById('p_name').value = item.item_name;
    document.getElementById('p_price').value = item.unit_price;
    document.getElementById('p_image').value = item.image;
  } else {
    // æ–°å¢æ¨¡å¼
    title.textContent = 'â• æ–°å¢å•†å“';
    // è‡ªå‹•ç”¢ç”Ÿä¸€å€‹æ–° ID (å–ç•¶ä¸‹æ™‚é–“æˆ³è¨˜)
    const newId = 'new_' + Math.floor(Date.now() / 1000); 
    document.getElementById('p_id').value = newId;
    document.getElementById('p_name').value = '';
    document.getElementById('p_price').value = '';
    document.getElementById('p_image').value = '';
  }
  
  modal.classList.add('show');
}

async function saveProduct() {
  const id = document.getElementById('p_id').value;
  const name = document.getElementById('p_name').value;
  const price = document.getElementById('p_price').value;
  const image = document.getElementById('p_image').value;
  
  if (!name || !price) { alert('åç¨±èˆ‡åƒ¹æ ¼ç‚ºå¿…å¡«'); return; }
  
  const btn = event.target;
  btn.disabled = true;
  btn.textContent = 'å„²å­˜ä¸­...';
  
  try {
    const res = await fetch(API_PRODUCT_SAVE, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        item_id: id,
        item_name: name,
        unit_price: price,
        image: image
      })
    });
    const data = await res.json();
    if (data.success) {
      alert('âœ… å•†å“å·²å„²å­˜');
      document.getElementById('productModal').classList.remove('show');
      loadListing(); // é‡æ•´åˆ—è¡¨
    } else {
      alert('âŒ å„²å­˜å¤±æ•—');
    }
  } catch(e) {
    alert('é€£ç·šéŒ¯èª¤');
  } finally {
    btn.disabled = false;
    btn.textContent = 'å„²å­˜';
  }
}
  async function uploadImage(input) {
  const file = input.files[0];
  if (!file) return;
  
  const status = document.getElementById('uploadStatus');
  const urlInput = document.getElementById('p_image');
  
  status.textContent = 'â³ ä¸Šå‚³ä¸­...';
  status.style.color = '#666';
  
  const formData = new FormData();
  formData.append('file', file); // å°æ‡‰ n8n Webhook çš„æ¬„ä½
  
  try {
    const res = await fetch(API_PRODUCT_UPLOAD, {
      method: 'POST',
      body: formData // Fetch æœƒè‡ªå‹•è¨­å®š multipart/form-data
    });
    const data = await res.json();
    
    if (data.success) {
      status.textContent = 'âœ… ä¸Šå‚³æˆåŠŸï¼';
      status.style.color = 'green';
      urlInput.value = data.url; // è‡ªå‹•å¡«å…¥ç¶²å€
    } else {
      status.textContent = 'âŒ ä¸Šå‚³å¤±æ•—: ' + (data.message || 'æœªçŸ¥éŒ¯èª¤');
      status.style.color = 'red';
    }
  } catch(e) {
    status.textContent = 'âŒ é€£ç·šéŒ¯èª¤';
    status.style.color = 'red';
    console.error(e);
  } finally {
    // æ¸…ç©º input è®“åŒä¸€æª”æ¡ˆå¯é‡è¤‡é¸å–
    input.value = '';
  }
}
  window.onload=function(){
  loadOrders();
  // å¦‚æœæœ‰åˆ‡æ›åˆ°åº«å­˜åˆ†é ï¼Œä¹Ÿå¯ä»¥åœ¨é€™è£¡é è¼‰
};
  async function uploadImage(input) {
  const file = input.files[0];
  if (!file) return;
  
  const status = document.getElementById('uploadStatus');
  const urlInput = document.getElementById('p_image');
  
  status.textContent = 'â³ ä¸Šå‚³ä¸­...';
  status.style.color = '#666';
  
  const formData = new FormData();
  formData.append('file', file); // æ¬„ä½å 'file' è¦å°æ‡‰ n8n Webhook
  
  try {
    const res = await fetch('https://chihwei-n8n.zeabur.app/webhook/product-upload-image', {
      method: 'POST',
      body: formData // ä¸è¦è¨­ Content-Type, fetch æœƒè‡ªå‹•è¨­ç‚º multipart/form-data
    });
    const data = await res.json();
    
    if (data.success) {
      status.textContent = 'âœ… ä¸Šå‚³æˆåŠŸï¼';
      status.style.color = 'green';
      urlInput.value = data.url; // è‡ªå‹•å¡«å…¥ç¶²å€
    } else {
      status.textContent = 'âŒ ä¸Šå‚³å¤±æ•—';
      status.style.color = 'red';
    }
  } catch(e) {
    status.textContent = 'âŒ é€£ç·šéŒ¯èª¤';
    console.error(e);
  }
}
</script>

</body>
</html>
