<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Phase 3ï½œå…¬é—œå“ç”³è«‹ç³»çµ±ï¼å¾Œè‡ºç®¡ç†</title>

<style>
  body{
    font-family:-apple-system,BlinkMacSystemFont,"Noto Sans TC",Arial,sans-serif;
    background:#f6f7f9;
    margin:0;
    padding:20px;
  }
  h1{ text-align:center; margin:0 0 18px; }
  .container{ max-width:1200px; margin:0 auto; }

  /* ===== å¡ç‰‡ ===== */
  .panel{
    background:#fff;
    border-radius:12px;
    padding:16px;
    box-shadow:0 2px 10px rgba(0,0,0,0.08);
    margin-bottom:18px;
  }

  /* ===== ä¸Šæ–¹åˆ— ===== */
  .topbar{
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
    flex-wrap:wrap;
    margin-bottom:12px;
  }
  .badge{
    display:inline-block;
    padding:4px 10px;
    border-radius:999px;
    font-size:12px;
    background:#eef2ff;
    color:#1e40af;
  }
  .btn{
    border:none;
    padding:10px 14px;
    border-radius:10px;
    cursor:pointer;
    font-size:14px;
  }
  .btn-primary{ background:#0A84FF; color:#fff; }
  .btn-ghost{ background:#f1f5f9; color:#111; }
  .btn-danger{ background:#dc3545; color:#fff; }

  /* ===== Tabs ===== */
  .tabs{
    display:flex;
    gap:8px;
    margin:10px 0 0;
    flex-wrap:wrap;
  }
  .tab{
    padding:10px 14px;
    border-radius:999px;
    cursor:pointer;
    background:#f1f5f9;
    font-size:14px;
  }
  .tab.active{
    background:#0A84FF;
    color:#fff;
  }

  /* ===== è¡¨æ ¼ ===== */
  table{
    width:100%;
    border-collapse:collapse;
    background:#fff;
    overflow:hidden;
    border-radius:12px;
  }
  th, td{
    padding:10px;
    border-bottom:1px solid #eee;
    text-align:left;
    vertical-align:top;
    font-size:14px;
  }
  th{ background:#f0f2f5; user-select:none; }
  tr:hover td{ background:#fafafa; }

  .muted{ color:#666; font-size:13px; }
  .small{ font-size:12px; color:#666; }

  /* ===== ç‹€æ…‹ ===== */
  .status-pill{
    display:inline-block;
    padding:4px 10px;
    border-radius:999px;
    font-size:12px;
    background:#eef2f7;
    color:#111;
    white-space:nowrap;
  }
  .s-submitted{ background:#e0f2fe; color:#075985; }
  .s-preparing{ background:#fff7ed; color:#9a3412; }
  .s-ready{ background:#ecfdf5; color:#065f46; }
  .s-exception{ background:#fee2e2; color:#991b1b; }

  /* ===== Form ===== */
  .grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
  }
  @media (max-width: 860px){
    .grid{ grid-template-columns:1fr; }
  }
  label{ font-size:13px; color:#333; display:block; margin-bottom:6px; }
  input, select, textarea{
    width:100%;
    padding:10px;
    border:1px solid #ccc;
    border-radius:10px;
    font-size:14px;
    box-sizing:border-box;
    background:#fff;
  }
  textarea{ min-height:88px; resize:vertical; }

  .row{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
  }

  /* ===== Modal ===== */
  .modal-backdrop{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.35);
    display:none;
    align-items:center;
    justify-content:center;
    padding:16px;
    z-index:50;
  }
  .modal{
    width: min(900px, 100%);
    background:#fff;
    border-radius:14px;
    box-shadow:0 10px 40px rgba(0,0,0,0.25);
    overflow:hidden;
  }
  .modal-header{
    padding:14px 16px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    background:#0A84FF;
    color:#fff;
  }
  .modal-body{ padding:16px; }
  .modal-footer{
    padding:14px 16px;
    background:#f8fafc;
    display:flex;
    gap:10px;
    justify-content:flex-end;
    flex-wrap:wrap;
  }

  .hidden{ display:none; }

  /* ===== Login ===== */
  .login-wrap{
    min-height: calc(100vh - 40px);
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .login-card{
    width:min(520px, 100%);
    background:#fff;
    border-radius:14px;
    padding:18px;
    box-shadow:0 2px 16px rgba(0,0,0,0.10);
  }
  .login-card h2{ margin:0 0 12px; }
</style>
</head>

<body>

<div id="loginPage" class="login-wrap">
  <div class="login-card">
    <h2>ğŸ” å¾Œè‡ºç™»å…¥ï¼ˆPhase 3 Admin Demoï¼‰</h2>
    <div class="muted" style="margin-bottom:12px;">
      é€™æ˜¯å±•ç¤ºç‰ˆï¼ˆè™›æ“¬å¸³è™Ÿï¼‰ã€‚ä¹‹å¾Œå¯æ¥ n8n åšçœŸæ­£çš„ç™½åå–®é©—è­‰ã€‚
    </div>

    <div style="margin-bottom:12px;">
      <label>å¸³è™Ÿ</label>
      <input id="loginUser" placeholder="ä¾‹ï¼šadmin" />
    </div>

    <div style="margin-bottom:12px;">
      <label>å¯†ç¢¼</label>
      <input id="loginPass" type="password" placeholder="ä¾‹ï¼š1234" />
    </div>

    <div class="row">
      <button class="btn btn-primary" onclick="doLogin()">ç™»å…¥</button>
      <span class="small">æ¸¬è©¦å¸³å¯†ï¼šadmin / 1234</span>
    </div>
  </div>
</div>

<div id="adminPage" class="container hidden">
  <h1>ğŸ› ï¸ å…¬é—œå“ç”³è«‹ç³»çµ±ï¼å¾Œè‡ºç®¡ç†ï¼ˆPhase 3ï¼‰</h1>

  <!-- Top Panel -->
  <div class="panel">
    <div class="topbar">
      <div>
        <span class="badge" id="adminInfo">Admin: -</span>
        <span class="badge" id="nowTime">-</span>
      </div>
      <div class="row">
        <button class="btn btn-ghost" onclick="seedData()">é‡ç½®è™›æ“¬è³‡æ–™</button>
        <button class="btn btn-danger" onclick="logout()">ç™»å‡º</button>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" id="tabOrders" onclick="switchTab('orders')">A. è¨‚å–®ç®¡ç†</div>
      <div class="tab" id="tabInventory" onclick="switchTab('inventory')">B. å•†å“èˆ‡åº«å­˜ç›¤é»</div>
      <div class="tab" id="tabLogs" onclick="switchTab('logs')">C. ç›¤é»ç´€éŒ„</div>
    </div>
  </div>

  <!-- A. Orders -->
  <div id="viewOrders" class="panel">
    <div class="topbar">
      <div>
        <b>è¨‚å–®åˆ—è¡¨</b>
        <div class="muted">å¯ç¯©é¸ã€æŸ¥çœ‹æ˜ç´°ã€æ›´æ–°ç‹€æ…‹ï¼ˆå«é˜²å‘†ï¼‰ã€‚</div>
      </div>

      <div class="row">
        <select id="filterStatus" onchange="renderOrders()">
          <option value="">å…¨éƒ¨ç‹€æ…‹</option>
          <option value="SUBMITTED">ç”³è«‹æå‡º</option>
          <option value="PREPARING">å•†å“æº–å‚™ä¸­</option>
          <option value="READY">å·²é€šçŸ¥é ˜å–ï¼ˆçµæ¡ˆï¼‰</option>
          <option value="EXCEPTION">ç•°å¸¸é€šçŸ¥</option>
        </select>
        <input id="filterKeyword" placeholder="æœå°‹ï¼štask_id / å§“å / å“¡ç·¨ / éƒ¨é–€" oninput="renderOrders()" />
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>è¨‚å–®ç·¨è™Ÿ</th>
          <th>ç”³è«‹äºº</th>
          <th>éƒ¨é–€</th>
          <th>ç”³è«‹æ—¥æœŸ</th>
          <th>ç¸½é‡‘é¡</th>
          <th>ç‹€æ…‹</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="ordersBody"></tbody>
    </table>
  </div>

  <!-- B. Inventory -->
  <div id="viewInventory" class="panel hidden">
    <div class="topbar">
      <div>
        <b>å•†å“èˆ‡åº«å­˜ç›¤é»</b>
        <div class="muted">è¼¸å…¥ã€Œèª¿æ•´é‡ã€å¾Œæ›´æ–°ï¼Œä¸¦è‡ªå‹•å¯«å…¥ç›¤é»ç´€éŒ„ï¼ˆStock Logï¼‰ã€‚</div>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>å•†å“</th>
          <th>å–®åƒ¹</th>
          <th>ç¾æœ‰åº«å­˜</th>
          <th>ç›¤é»èª¿æ•´ï¼ˆ+/-ï¼‰</th>
          <th>å‚™è¨»</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="itemsBody"></tbody>
    </table>
  </div>

  <!-- C. Logs -->
  <div id="viewLogs" class="panel hidden">
    <div class="topbar">
      <div>
        <b>ç›¤é»ç´€éŒ„ï¼ˆStock Logï¼‰</b>
        <div class="muted">è¿½è¹¤æ¯æ¬¡åº«å­˜ç•°å‹•ï¼šèª°æ”¹ã€ä½•æ™‚æ”¹ã€æ”¹äº†å¤šå°‘ã€åŸå› ã€‚</div>
      </div>
      <div class="row">
        <button class="btn btn-ghost" onclick="clearLogs()">æ¸…ç©ºç´€éŒ„ï¼ˆdemoï¼‰</button>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>æ™‚é–“</th>
          <th>ç®¡ç†è€…</th>
          <th>å•†å“</th>
          <th>åŸåº«å­˜</th>
          <th>æ–°åº«å­˜</th>
          <th>å‚™è¨»</th>
        </tr>
      </thead>
      <tbody id="logsBody"></tbody>
    </table>
  </div>
</div>

<!-- ===== è¨‚å–®æ˜ç´° Modal ===== -->
<div id="orderModalBackdrop" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <div><b id="modalTitle">è¨‚å–®æ˜ç´°</b></div>
      <button class="btn btn-ghost" onclick="closeOrderModal()">é—œé–‰</button>
    </div>

    <div class="modal-body">
      <div class="grid">
        <div class="panel" style="margin:0;">
          <b>åŸºæœ¬è³‡è¨Š</b>
          <div class="muted" id="modalBaseInfo" style="margin-top:8px;"></div>
        </div>

        <div class="panel" style="margin:0;">
          <b>ç‹€æ…‹æ›´æ–°ï¼ˆAdminï¼‰</b>
          <div style="margin-top:10px;">
            <label>æ›´æ–°ç‹€æ…‹</label>
            <select id="modalStatus">
              <option value="SUBMITTED">ç”³è«‹æå‡º</option>
              <option value="PREPARING">å•†å“æº–å‚™ä¸­</option>
              <option value="READY">å·²é€šçŸ¥é ˜å–ï¼ˆçµæ¡ˆï¼‰</option>
              <option value="EXCEPTION">ç•°å¸¸é€šçŸ¥</option>
            </select>
          </div>

          <div style="margin-top:10px;">
            <label>è™•ç†å‚™è¨»ï¼ˆEXCEPTION å¿…å¡«ï¼‰</label>
            <textarea id="modalNote" placeholder="ä¾‹ï¼šå“é …ç¼ºè²¨ï¼Œå·²é€šçŸ¥æ”¹æœŸ / æ”¹å–®"></textarea>
          </div>

          <div class="muted" style="margin-top:8px;">
            é˜²å‘†ï¼šçµæ¡ˆå¾Œä¸å¯å†æ”¹ï¼›ç‹€æ…‹ä¸å¯å€’é€€ï¼›ç•°å¸¸éœ€å‚™è¨»ã€‚
          </div>
        </div>
      </div>

      <div class="panel" style="margin-top:12px;">
        <b>ç”³è«‹å“é …</b>
        <div id="modalItems" style="margin-top:10px;" class="muted"></div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeOrderModal()">å–æ¶ˆ</button>
      <button class="btn btn-primary" onclick="saveOrderStatus()">å„²å­˜ç‹€æ…‹</button>
    </div>
  </div>
</div>

<script>
  console.log('SCRIPT START');

/* =========================
   Demo Session / Login
========================= */
let currentAdmin = null;
const DEMO_USERS = [{ user:'admin', pass:'1234', name:'ç¸½å‹™ç®¡ç†è€…-Admin' }];

console.log('before doLogin');

function doLogin(){
  console.log('doLogin called');
  ...
}

console.log('after doLogin');
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value.trim();

  const ok = DEMO_USERS.find(x => x.user === u && x.pass === p);
  if(!ok){
    alert('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ï¼ˆdemoï¼šadmin / 1234ï¼‰');
    return;
  }

  currentAdmin = ok.name;
  document.getElementById('loginPage').classList.add('hidden');
  document.getElementById('adminPage').classList.remove('hidden');
  document.getElementById('adminInfo').textContent = `Admin: ${currentAdmin}`;

  seedData();
  tickClock();
  setInterval(tickClock, 1000);
}

function logout(){
  currentAdmin = null;
  document.getElementById('adminPage').classList.add('hidden');
  document.getElementById('loginPage').classList.remove('hidden');
}

function tickClock(){
  const d = new Date();
  document.getElementById('nowTime').textContent = d.toLocaleString('zh-TW');
}

/* =========================
   Mock Data (Orders / Items / Logs)
========================= */
let ORDERS = [];
let ITEMS = [];
let STOCK_LOGS = [];

function seedData(){
  ORDERS = [
    {
      task_id:'TASK-20260204-031',
      name:'ç‹å°æ˜', staff:'123456', dept:'æ€¥è¨ºé†«å­¸éƒ¨',
      created_at:'2026/02/04 10:12',
      updated_at:'2026/02/04 10:12',
      status:'PREPARING',
      amount:1240,
      items:[
        { item_id:'I001', item_name:'ç’°ä¿æè¢‹', unit_price:50, qty:20, subtotal:1000 },
        { item_id:'I002', item_name:'ä¸‰è‰²ç­†', unit_price:8, qty:30, subtotal:240 }
      ],
      admin_note:''
    },
    {
      task_id:'TASK-20260203-028',
      name:'é™³é›…å©·', staff:'234567', dept:'è­·ç†éƒ¨',
      created_at:'2026/02/03 14:05',
      updated_at:'2026/02/03 14:05',
      status:'SUBMITTED',
      amount:980,
      items:[
        { item_id:'I003', item_name:'å®£å°è³‡æ–™å¤¾', unit_price:19.6, qty:50, subtotal:980 }
      ],
      admin_note:''
    },
    {
      task_id:'TASK-20260202-021',
      name:'æ—å¿—å®', staff:'345678', dept:'æ•™å­¸éƒ¨',
      created_at:'2026/02/02 09:30',
      updated_at:'2026/02/02 11:00',
      status:'EXCEPTION',
      amount:560,
      items:[
        { item_id:'I004', item_name:'è­˜åˆ¥è­‰å¥—', unit_price:14, qty:40, subtotal:560 }
      ],
      admin_note:'å“é …è‡¨æ™‚ç¼ºè²¨ï¼Œå·²é€šçŸ¥æ”¹æœŸé ˜å–'
    },
    {
      task_id:'TASK-20260131-018',
      name:'é»ƒæ€¡å›', staff:'456789', dept:'äººè³‡å®¤',
      created_at:'2026/01/31 16:20',
      updated_at:'2026/02/05 13:40',
      status:'READY',
      amount:460,
      items:[
        { item_id:'I005', item_name:'åŒ—é†«å¹³å®‰åŒ…', unit_price:460, qty:1, subtotal:460 }
      ],
      admin_note:'å·²é€šçŸ¥é ˜å–'
    }
  ];

  ITEMS = [
    { item_id:'I001', name:'ç’°ä¿æè¢‹', price:50, stock:200, is_active:true },
    { item_id:'I002', name:'ä¸‰è‰²ç­†', price:8, stock:500, is_active:true },
    { item_id:'I003', name:'å®£å°è³‡æ–™å¤¾', price:19.6, stock:120, is_active:true },
    { item_id:'I004', name:'è­˜åˆ¥è­‰å¥—', price:14, stock:80, is_active:true },
    { item_id:'I005', name:'åŒ—é†«å¹³å®‰åŒ…', price:460, stock:15, is_active:true }
  ];

  STOCK_LOGS = [
    { at:'2026/02/01 09:10', by:'ç¸½å‹™ç®¡ç†è€…-Admin', item:'ç’°ä¿æè¢‹(I001)', before:180, after:200, note:'å¹´åº¦è£œè²¨ +20' },
    { at:'2026/02/03 18:05', by:'ç¸½å‹™ç®¡ç†è€…-Admin', item:'åŒ—é†«å¹³å®‰åŒ…(I005)', before:18, after:15, note:'ç›¤é»æ ¡æ­£ -3' }
  ];

  renderAll();
}

function statusText(s){
  return ({
    SUBMITTED:'ç”³è«‹æå‡º',
    PREPARING:'å•†å“æº–å‚™ä¸­',
    READY:'å·²é€šçŸ¥é ˜å–ï¼ˆçµæ¡ˆï¼‰',
    EXCEPTION:'ç•°å¸¸é€šçŸ¥'
  })[s] || s;
}
function statusClass(s){
  return ({
    SUBMITTED:'s-submitted',
    PREPARING:'s-preparing',
    READY:'s-ready',
    EXCEPTION:'s-exception'
  })[s] || '';
}

/* =========================
   Tab Switch
========================= */
function switchTab(tab){
  document.getElementById('tabOrders').classList.toggle('active', tab==='orders');
  document.getElementById('tabInventory').classList.toggle('active', tab==='inventory');
  document.getElementById('tabLogs').classList.toggle('active', tab==='logs');

  document.getElementById('viewOrders').classList.toggle('hidden', tab!=='orders');
  document.getElementById('viewInventory').classList.toggle('hidden', tab!=='inventory');
  document.getElementById('viewLogs').classList.toggle('hidden', tab!=='logs');
}

/* =========================
   Render
========================= */
function renderAll(){
  renderOrders();
  renderItems();
  renderLogs();
}

function renderOrders(){
  const body = document.getElementById('ordersBody');
  body.innerHTML = '';

  const fStatus = document.getElementById('filterStatus').value;
  const kw = document.getElementById('filterKeyword').value.trim().toLowerCase();

  let rows = [...ORDERS];

  if(fStatus) rows = rows.filter(o => o.status === fStatus);
if (kw) {
  rows = rows.filter(o =>
    o.task_id.toLowerCase().includes(kw) ||
    o.name.toLowerCase().includes(kw) ||
    o.staff.toLowerCase().includes(kw) ||
    o.dept.toLowerCase().includes(kw)
  );
}
