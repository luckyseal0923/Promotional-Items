<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å…¬é—œå“å¾Œè‡ºç®¡ç†ç³»çµ±</title>
<style>
:root { --primary: #10B981; --primary-dark: #059669; --bg: #F8FAFC; --text: #334155; --border: #E2E8F0; --danger: #EF4444; }
body,html{margin:0;height:100%;font-family:"PingFang TC",sans-serif;background:var(--bg);color:var(--text)}
.hidden{display:none!important}
.sidebar{width:260px;background:#fff;height:100vh;position:fixed;padding:24px;border-right:1px solid var(--border);box-sizing:border-box;z-index:100}
.main-content{margin-left:260px;padding:30px}
@media (max-width: 900px) { .sidebar{width:70px;padding:15px 5px;text-align:center} .sidebar h2,.sidebar .nav-text{display:none} .main-content{margin-left:70px;padding:15px} }
.nav-item{padding:14px 18px;border-radius:10px;margin-bottom:8px;cursor:pointer;color:#64748B;display:flex;align-items:center;gap:12px;transition:0.2s}
.nav-item.active{background:var(--primary);color:#fff;font-weight:bold}
.panel{background:#fff;border-radius:12px;padding:24px;border:1px solid var(--border);margin-bottom:24px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
h1{font-size:22px;border-left:5px solid var(--primary);padding-left:14px;margin-bottom:24px;color:#0F172A}
table{width:100%;border-collapse:collapse;min-width:800px}
th{text-align:left;padding:12px;background:#F8FAFC;border-bottom:2px solid var(--border);font-size:13px}
td{padding:16px 12px;border-bottom:1px solid var(--border);font-size:14px}
.table-wrapper{overflow-x:auto}
.btn{padding:10px 16px;border-radius:8px;border:none;cursor:pointer;font-size:13px;font-weight:600;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:var(--primary);color:#fff}
.btn-success{background:#10B981;color:#fff}
.btn-outline{background:#fff;border:1px solid var(--border);color:var(--text)}
.status-pill{padding:4px 10px;border-radius:6px;font-size:12px;font-weight:bold}
.status-preparing{background:#DBEAFE;color:#1E40AF}
.status-submitted{background:#FEF3C7;color:#92400E}
.status-ready{background:#D1FAE5;color:#065F46}
.status-exception{background:#FEE2E2;color:#991B1B}
.status-end{background:#E5E7EB;color:#374151}
input,select{padding:12px;border:1px solid var(--border);border-radius:8px;outline:none;box-sizing:border-box;font-size:14px}
.modal{position:fixed;inset:0;background:rgba(15,23,42,0.5);display:none;align-items:center;justify-content:center;z-index:5000;padding:15px}
.modal.show{display:flex}
.modal-body{background:#fff;padding:30px;border-radius:16px;width:100%;max-width:550px;max-height:90vh;overflow-y:auto}
.info-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px dashed #E2E8F0}
.info-label{color:#64748B;font-size:14px} .info-value{font-weight:600;font-size:14px}
</style>
</head>
<body>
  <div id="adminView">
  <div class="sidebar">
    <h2 style="color:var(--primary-dark);margin-bottom:30px">å…¬é—œå“å¾Œè‡º</h2>
    <div class="nav-item active" id="nav-orders" onclick="switchTab('orders')">ğŸ“‹ <span class="nav-text">è¨‚å–®ç®¡ç†ç³»çµ±</span></div>
    <div class="nav-item" id="nav-inventory" onclick="switchTab('inventory')">âš–ï¸ <span class="nav-text">åº«å­˜ç›¤é»</span></div>
    <div class="nav-item" id="nav-listing" onclick="switchTab('listing')">ğŸš€ <span class="nav-text">å•†å“ç®¡ç†</span></div>
    <div class="nav-item" id="nav-accounts" onclick="switchTab('accounts')">ğŸ‘¥ <span class="nav-text">å¸³è™Ÿç®¡ç†</span></div>
    <div style="margin-top:50px"><button class="btn btn-outline" style="width:100%">å®‰å…¨ç™»å‡º</button></div>
  </div>

  <div class="main-content">
    <!-- è¨‚å–® -->
    <div id="tab-orders">
      <h1>è¨‚å–®ç®¡ç†ç³»çµ±</h1>
      <div id="orderError" class="hidden" style="padding:14px;background:#FEE2E2;color:#991B1B;border-radius:10px;margin-bottom:16px">âš ï¸ è¼‰å…¥å¤±æ•—</div>
      <div class="panel">
        <div style="display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;align-items:center">
          <input type="date" id="dateFrom" onchange="filterOrders()"> è‡³ <input type="date" id="dateTo" onchange="filterOrders()">
          <select id="statusFilter" onchange="filterOrders()" style="min-width:120px">
            <option value="">å…¨éƒ¨ç‹€æ…‹</option>
            <option value="Submitted">ç”³è«‹æå‡º</option>
            <option value="PREPARING">å•†å“æº–å‚™ä¸­</option>
            <option value="ready">é€šçŸ¥é ˜å–</option>
            <option value="EXCEPTION">ç•°å¸¸é€šçŸ¥</option>
            <option value="End">æ¡ˆä»¶çµæ¡ˆ</option>
          </select>
          <input type="text" id="searchKeyword" placeholder="æœå°‹å–®è™Ÿ/ç”³è«‹äºº" style="width:150px">
          <button class="btn btn-primary" onclick="filterOrders()">ğŸ” ç¯©é¸</button>
          <button class="btn btn-outline" onclick="resetFilter()">é‡ç½®</button>
          <button class="btn btn-success" onclick="downloadCSV()">ğŸ“¥ ä¸‹è¼‰å ±è¡¨</button>
        </div>
        <div class="table-wrapper">
          <table>
            <thead><tr><th>æ—¥æœŸ / å–®è™Ÿ</th><th>ç”³è«‹äºº</th><th>å–®ä½</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="orderTable"><tr><td colspan="5" style="text-align:center;padding:30px">è¼‰å…¥ä¸­...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
     <!-- åº«å­˜ -->
    <div id="tab-inventory" class="hidden">
      <h1>åº«å­˜ç›¤é»</h1>
      <div class="panel">è¼‰å…¥ä¸­...</div>
    </div>

    <!-- å•†å“ -->
    <div id="tab-listing" class="hidden">
      <h1>å•†å“ç®¡ç†</h1>
      <div class="panel">è¼‰å…¥ä¸­...</div>
    </div>

    <!-- å¸³è™Ÿ -->
    <div id="tab-accounts" class="hidden">
      <h1>å¸³è™Ÿç®¡ç†</h1>
      <div class="panel">ï¼ˆåŠŸèƒ½é–‹ç™¼ä¸­ï¼‰</div>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="orderModal" class="modal"><div class="modal-body"><h3 class="modal-title">ğŸ“‹ è¨‚å–®è©³ç´°è³‡è¨Š</h3><div id="orderDetail"></div><button class="btn btn-primary" style="width:100%;margin-top:20px" onclick="document.getElementById('orderModal').classList.remove('show')">é—œé–‰</button></div></div>

<script>
const API_ORDERS = 'https://chihwei-n8n.zeabur.app/webhook/orders';
const API_INVENTORY_LIST = 'https://chihwei-n8n.zeabur.app/webhook/inventory-list';
const API_INVENTORY_UPDATE = 'https://chihwei-n8n.zeabur.app/webhook/inventory-update';
const API_PRODUCT_SAVE = 'https://chihwei-n8n.zeabur.app/webhook/product-save';
const API_PRODUCT_UPLOAD = 'https://chihwei-n8n.zeabur.app/webhook/product-upload-image';

let ALL_ORDERS = [], FILTERED_ORDERS = [], ALL_PRODUCTS = [];

const STATUS_MAP = {'Submitted':'ç”³è«‹æå‡º','PREPARING':'å•†å“æº–å‚™ä¸­','preparing':'å•†å“æº–å‚™ä¸­','ready':'é€šçŸ¥é ˜å–','EXCEPTION':'ç•°å¸¸é€šçŸ¥','End':'æ¡ˆä»¶çµæ¡ˆ','done':'æ¡ˆä»¶çµæ¡ˆ','closed':'æ¡ˆä»¶çµæ¡ˆ'};
const STATUS_CLASS = {'Submitted':'status-submitted','PREPARING':'status-preparing','preparing':'status-preparing','ready':'status-ready','EXCEPTION':'status-exception','End':'status-end','done':'status-end','closed':'status-end'};
  function getStatusText(s){return STATUS_MAP[s]||s||'æœªçŸ¥';}
function getStatusClass(s){return STATUS_CLASS[s]||'status-preparing';}
function formatDate(d){if(!d)return'-';const n=new Date(d);return isNaN(n)?d:n.toLocaleDateString('zh-TW');}
function formatDateTime(d){if(!d)return'-';const n=new Date(d);return isNaN(n)?d:n.toLocaleString('zh-TW');}

function switchTab(tab){
  ['orders','inventory','listing','accounts'].forEach(t=>{
    document.getElementById('tab-'+t).classList.add('hidden');
    document.getElementById('nav-'+t).classList.remove('active');
  });
  document.getElementById('tab-'+tab).classList.remove('hidden');
  document.getElementById('nav-'+tab).classList.add('active');
  
  if(tab==='orders' && ALL_ORDERS.length===0) loadOrders();
  if(tab==='inventory') loadInventory();
  if(tab==='listing') loadListing();
}

/* è¨‚å–® */
async function loadOrders(){
  try{
    const res=await fetch(API_ORDERS);
    const data=await res.json();
    ALL_ORDERS=[...(data.orders?.active||[]),...(data.orders?.archived||[])];
    FILTERED_ORDERS=[...ALL_ORDERS];
    renderOrders();
  }catch(e){ console.error(e); document.getElementById('orderError').classList.remove('hidden'); }
}
  function filterOrders(){
  const df=document.getElementById('dateFrom').value, dt=document.getElementById('dateTo').value;
  const sf=document.getElementById('statusFilter').value, kw=document.getElementById('searchKeyword').value.toLowerCase().trim();
  FILTERED_ORDERS=ALL_ORDERS.filter(o=>{
    if(df || dt){ const od=o.date?new Date(o.date).toISOString().split('T')[0]:''; if(df&&od<df)return false; if(dt&&od>dt)return false; }
    if(sf && o.status!==sf) return false;
    if(kw && !(o.task_id||'').toLowerCase().includes(kw) && !(o.user||'').toLowerCase().includes(kw)) return false;
    return true;
  });
  renderOrders();
}
function resetFilter(){
  document.getElementById('dateFrom').value='';document.getElementById('dateTo').value='';document.getElementById('statusFilter').value='';document.getElementById('searchKeyword').value='';
  FILTERED_ORDERS=[...ALL_ORDERS]; renderOrders();
}

function renderOrders(){
  const tb=document.getElementById('orderTable');
  if(FILTERED_ORDERS.length===0){ tb.innerHTML='<tr><td colspan="5" style="text-align:center;padding:30px">ç„¡è³‡æ–™</td></tr>'; return; }
  tb.innerHTML=FILTERED_ORDERS.map(o=>
    `<tr>
      <td><div style="font-weight:bold">${formatDate(o.date)}</div><div style="font-size:11px;color:#999">${o.task_id||'-'}</div></td>
      <td>${o.user||'-'}</td><td>${o.department||'-'}</td>
      <td><span class="status-pill ${getStatusClass(o.status)}">${getStatusText(o.status)}</span></td>
      <td>
        <button class="btn btn-outline" onclick="showOrderDetail('${o.task_id}')">ğŸ“‹ æŸ¥è©¢</button>
        <button class="btn btn-primary" onclick="showEditStatus('${o.task_id}')">âœï¸ ç‹€æ…‹</button>
      </td>
    </tr>`
  ).join('');
}
  function showOrderDetail(tid){
  const o=ALL_ORDERS.find(x=>x.task_id===tid); if(!o)return;
  let ih=(o.items||[]).map(i=>`<div style="display:flex;justify-content:space-between;padding:5px 0"><span>${i.item_name||i.name}</span><span>x${i.quantity||i.qty}</span></div>`).join('')||'ç„¡æ˜ç´°';
  let h=`<div style="background:#F8FAFC;padding:15px;border-radius:8px">
    <div class="info-row"><span class="info-label">å–®è™Ÿ</span><span>${o.task_id}</span></div>
    <div class="info-row"><span class="info-label">ç”³è«‹äºº</span><span>${o.user}</span></div>
    <div class="info-row"><span class="info-label">ç‹€æ…‹</span><span>${getStatusText(o.status)}</span></div>
    ${(o.status==='EXCEPTION'&&o.comment)?`<div style="background:#FEE2E2;color:#991B1B;padding:10px;margin-top:10px;border-radius:4px">ğŸ”´ ç•°å¸¸ï¼š${o.comment}</div>`:''}
    <div class="info-row"><span class="info-label">é‡‘é¡</span><span style="color:var(--primary)">$${o.total||0}</span></div>
  </div><h4 style="margin:15px 0 5px">ğŸ“¦ æ˜ç´°</h4>${ih}`;
  document.getElementById('orderDetail').innerHTML=h;
  document.getElementById('orderModal').classList.add('show');
}

function showEditStatus(tid){
  const o=ALL_ORDERS.find(x=>x.task_id===tid); if(!o)return;
  let h=`<div style="margin-bottom:15px">ç›®å‰ç‹€æ…‹ï¼š<span class="status-pill ${getStatusClass(o.status)}">${getStatusText(o.status)}</span></div>`;
  h+=`<select id="newStatus" style="width:100%" onchange="toggleReason()"><option value="Submitted">ç”³è«‹æå‡º</option><option value="PREPARING">å•†å“æº–å‚™ä¸­</option><option value="ready">é€šçŸ¥é ˜å–</option><option value="EXCEPTION">ç•°å¸¸é€šçŸ¥</option><option value="End">æ¡ˆä»¶çµæ¡ˆ</option></select>`;
  h+=`<div id="reasonField" style="display:none;margin-top:10px"><textarea id="statusNote" style="width:100%" placeholder="è¼¸å…¥ç•°å¸¸åŸå› ..."></textarea></div>`;
  h+=`<button class="btn btn-success" style="width:100%;margin-top:15px" onclick="updateStatus('${tid}')">ğŸ’¾ å„²å­˜</button>`;
  document.getElementById('orderDetail').innerHTML=h;
  document.getElementById('orderModal').classList.add('show');
  setTimeout(()=>{document.getElementById('newStatus').value=o.status; toggleReason();},0);
}

function toggleReason(){
  const s=document.getElementById('newStatus').value;
  document.getElementById('reasonField').style.display = (s==='EXCEPTION'?'block':'none');
}
  async function updateStatus(tid){
  const s=document.getElementById('newStatus').value, n=document.getElementById('statusNote')?.value;
  if(s==='EXCEPTION' && !n){ alert('è«‹å¡«å¯«ç•°å¸¸åŸå› '); return; }
  
  try{
    await fetch('https://chihwei-n8n.zeabur.app/webhook/update-order', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({task_id:tid, status:s, comment:n, updated_at:new Date().toISOString()})
    });
    alert('âœ… æ›´æ–°æˆåŠŸ'); document.getElementById('orderModal').classList.remove('show'); loadOrders();
  }catch(e){ alert('æ›´æ–°å¤±æ•—'); }
}

function downloadCSV() {
  if (FILTERED_ORDERS.length === 0) { alert('æ²’æœ‰è³‡æ–™å¯ä¸‹è¼‰'); return; }
  let csv = '\uFEFFæ—¥æœŸ,å–®è™Ÿ,ç”³è«‹äºº,å–®ä½,ç‹€æ…‹,é‡‘é¡\n';
  csv += FILTERED_ORDERS.map(o => 
    '"' + formatDate(o.date) + '","' + (o.task_id || '') + '","' + (o.user || '') + '","' + (o.department || '') + '","' + getStatusText(o.status) + '","' + (o.total || 0) + '"'
  ).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'è¨‚å–®å ±è¡¨_' + new Date().toISOString().slice(0, 10) + '.csv';
  link.click();
}
  /* åº«å­˜èˆ‡å•†å“ */
async function loadInventory(){
  const p=document.querySelector('#tab-inventory .panel');
  try{
    const res=await fetch(API_INVENTORY_LIST); const d=await res.json();
    ALL_PRODUCTS=d.items||[];
    renderInventory(ALL_PRODUCTS);
  }catch(e){ p.innerHTML='è¼‰å…¥å¤±æ•—'; }
}

function renderInventory(items) {
  const panel = document.querySelector('#tab-inventory .panel');
  let html = '<table style="width:100%"><thead><tr><th>åœ–</th><th>å“å</th><th>åº«å­˜</th><th>æ“ä½œ</th></tr></thead><tbody>';
  items.forEach(item => {
    const imgHtml = item.image 
      ? `<img src="${item.image}" style="height:40px;cursor:pointer" onclick="showBig('${item.image}')" title="é»æ“Šæ”¾å¤§">` 
      : '<span style="color:#ccc;font-size:12px;">ç„¡åœ–ç‰‡</span>';
    html += `<tr>
      <td style="width:80px;text-align:center;">${imgHtml}</td>
      <td style="font-weight:bold;font-size:15px;">${item.item_name}</td>
      <td style="font-size:16px;color:${item.stock < 10 ? 'red' : 'black'}">${item.stock}</td>
      <td>
        <div style="display:flex;gap:8px;align-items:center;">
          <input type="number" id="stock-${item.item_id}" value="${item.stock}" style="width:60px">
          <button class="btn btn-primary" onclick="updStock('${item.item_id}')">æ›´</button>
        </div>
      </td>
    </tr>`;
  });
  if (!document.getElementById('imgModal')) {
    const modalHtml = `<div id="imgModal" class="modal" onclick="this.style.display='none'"><img id="bigImage" style="max-width:90%;max-height:90%;margin:auto;display:block"></div>`;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
  }
  panel.innerHTML = html + '</tbody></table>';
}

async function updStock(id){
  const v=document.getElementById('stock-'+id).value;
  try{
    await fetch(API_INVENTORY_UPDATE, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({item_id:id, stock:v})});
    alert('å·²æ›´æ–°');
  }catch(e){ alert('å¤±æ•—'); }
}
  async function loadListing(){
  const p=document.querySelector('#tab-listing .panel');
  p.innerHTML='<div style="text-align:right;margin-bottom:10px"><button class="btn btn-success" onclick="editProd()">â• æ–°å¢</button></div>';
  try{
    if(ALL_PRODUCTS.length===0){ const res=await fetch(API_INVENTORY_LIST); const d=await res.json(); ALL_PRODUCTS=d.items||[]; }
    renderListing(ALL_PRODUCTS);
  }catch(e){ p.innerHTML='è¼‰å…¥å¤±æ•—'; }
}

function renderListing(items) {
  const panel = document.querySelector('#tab-listing .panel');
  let html = '<div style="margin-bottom:16px;text-align:right;"><button class="btn btn-success" onclick="editProd()">â• æ–°å¢å•†å“</button></div>';
  html += '<table style="width:100%"><thead><tr><th>åœ–ç‰‡</th><th>ID</th><th>å“å</th><th>å–®åƒ¹</th><th>æ“ä½œ</th></tr></thead><tbody>';
  items.forEach(item => {
    html += `<tr>
      <td>${item.image ? `<img src="${item.image}" style="height:40px;border-radius:4px;">` : '-'}</td>
      <td style="font-size:12px;color:#666;">${item.item_id}</td>
      <td style="font-weight:bold;">${item.item_name}</td>
      <td>$${item.unit_price}</td>
      <td><button class="btn btn-primary" onclick="editProd('${item.item_id}')">âœï¸ ç·¨è¼¯</button></td>
    </tr>`;
  });
  if (!document.getElementById('productModal')) { /* Modal HTML in editProd, just ensuring structure */ }
  panel.innerHTML = html + '</tbody></table>';
}

function editProd(id){
  const i=id?ALL_PRODUCTS.find(x=>x.item_id==id):null;
  const h=`<div id="prodModal" class="modal show"><div class="modal-body">
    <h3>${id?'ç·¨è¼¯':'æ–°å¢'}</h3>
    <input type="hidden" id="pid" value="${i?.item_id||'new_'+Date.now()}">
    <label>å“å</label><input type="text" id="pname" style="width:100%;margin-bottom:10px" value="${i?.item_name||''}">
    <label>åƒ¹æ ¼</label><input type="number" id="pprice" style="width:100%;margin-bottom:10px" value="${i?.unit_price||''}">
    <label>åœ–ç‰‡</label><div style="display:flex;gap:5px"><input type="text" id="pimg" style="flex:1" value="${i?.image||''}"><label class="btn btn-outline">ğŸ“¤<input type="file" hidden onchange="upImg(this)"></label></div>
    <div style="margin-top:15px;text-align:right"><button class="btn btn-outline" onclick="this.closest('.modal').remove()">å–æ¶ˆ</button> <button class="btn btn-success" onclick="saveProd()">å„²å­˜</button></div>
  </div></div>`;
  document.body.insertAdjacentHTML('beforeend', h);
}
  async function upImg(inp){
  const f=inp.files[0]; if(!f)return;
  const fd=new FormData(); fd.append('file', f);
  try{
    const res=await fetch(API_PRODUCT_UPLOAD, {method:'POST', body:fd});
    const d=await res.json();
    if(d.success) document.getElementById('pimg').value=d.url;
    else alert('ä¸Šå‚³å¤±æ•—');
  }catch(e){ alert('éŒ¯èª¤'); }
}

async function saveProd(){
  const id=document.getElementById('pid').value, name=document.getElementById('pname').value, price=document.getElementById('pprice').value, img=document.getElementById('pimg').value;
  try{
    await fetch(API_PRODUCT_SAVE, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({item_id:id, item_name:name, unit_price:price, image:img})});
    alert('å„²å­˜æˆåŠŸ'); document.getElementById('prodModal').remove(); loadListing();
  }catch(e){ alert('å¤±æ•—'); }
}

function showBig(src){
  const m = document.getElementById('imgModal');
  if(m) {
    m.querySelector('img').src = src;
    m.style.display = 'flex';
  }
}

function closeModal(){document.getElementById('orderModal').classList.remove('show');}
document.getElementById('orderModal').addEventListener('click',function(e){if(e.target===this)closeModal();});
window.onload=function(){ loadOrders(); };
</script>
</body>
</html>
