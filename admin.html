<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å…¬é—œå“å¾Œè‡ºç®¡ç†ç³»çµ± - Phase 3</title>

<style>
/* ===== åŸ CSS å®Œå…¨ä¸å‹• ===== */
:root {
  --primary:#10B981;
  --primary-dark:#059669;
  --bg:#F8FAFC;
  --text:#334155;
  --border:#E2E8F0;
  --danger:#EF4444;
}
body,html{height:100%;margin:0;font-family:"PingFang TC",sans-serif;background:var(--bg);color:var(--text)}
.hidden{display:none!important}
/* sidebar / panel / table / button / modal åŸæ¨£ä¿ç•™ */
</style>
</head>

<body>

<div id="adminView">
  <!-- ===== Sidebar / Tabs HTML åŸæ¨£ä¿ç•™ï¼ˆç•¥ï¼Œèˆ‡ä½ åŸæœ¬ç›¸åŒï¼‰ ===== -->
</div>

<div id="mainModal" class="modal">
  <div class="modal-body" id="modalBody"></div>
</div>

<script>
/* =========================
   Phase 3ï½œOrders API Only
   â— å”¯ä¸€æ–°å¢å€å¡Š
========================= */

const API_ORDERS_URL = 'https://ä½ çš„-n8n-domain/webhook/orders-admin';
let ORDERS = [];   // â— ä¿ç•™è®Šæ•¸ï¼Œä½†ä¸å†æœ‰å‡è³‡æ–™

async function fetchOrdersFromAPI() {
  try {
    const res = await fetch(API_ORDERS_URL);
    const data = await res.json();

    if (!data.orders || !Array.isArray(data.orders)) {
      throw new Error('orders format invalid');
    }

    ORDERS = data.orders.map(o => ({
      id: o.task_id,
      date: (o.created_at || '').slice(0,10),
      user: `${o.applicant_name || '-'} (${o.staff_id || '-'})`,
      dept: o.department || '-',
      status: mapStatus(o.status),
      items: o.items || [],
      raw: o
    }));

    renderOrders();

  } catch (e) {
    console.error(e);
    alert('è¨‚å–®è³‡æ–™è¼‰å…¥å¤±æ•—');
  }
}

function mapStatus(s){
  return ({
    SUBMITTED:'ç”³è«‹æå‡º',
    PREPARING:'å•†å“æº–å‚™ä¸­',
    READY:'é€šçŸ¥é ˜å–',
    EXCEPTION:'ç•°å¸¸é€šçŸ¥'
  })[s] || s;
}

/* =========================
   åŸæœ¬ renderOrdersï¼ˆåªå‹•ä¸€è¡Œï¼‰
========================= */

function renderOrders(){
  const tbody = document.getElementById('orderTable');
  if(!tbody) return;

  tbody.innerHTML = ORDERS.map(o => `
    <tr>
      <td>${o.date}</td>
      <td><b>${o.id}</b></td>
      <td>${o.user}</td>
      <td>
        <button class="btn btn-outline"
          onclick="showOrderDetail('${o.id}')">æŸ¥çœ‹æ˜ç´°</button>
      </td>
      <td><span class="status-pill status-1">${o.status}</span></td>
      <td>
        <select>
          <option>åˆ‡æ›...</option>
          <option>é€šçŸ¥é ˜å–</option>
          <option>ç•°å¸¸é€šçŸ¥</option>
        </select>
      </td>
    </tr>
  `).join('');
}

/* =========================
   åŸæœ¬ showOrderDetailï¼ˆé˜² undefinedï¼‰
========================= */

function showOrderDetail(id){
  const o = ORDERS.find(x => x.id === id);
  if(!o) return;

  const r = o.raw || {};

  openModal(`
    <h3>ğŸ“‹ è¨‚å–®è©³ç´°è³‡è¨Š</h3>
    <div class="panel">
      <div class="info-row"><b>ç”³è«‹äºº</b><span>${r.applicant_name||'-'}</span></div>
      <div class="info-row"><b>å“¡ç·¨</b><span>${r.staff_id||'-'}</span></div>
      <div class="info-row"><b>éƒ¨é–€</b><span>${r.department||'-'}</span></div>
      <div class="info-row"><b>ç¸½é‡‘é¡</b><span>NT$ ${r.total_amount||0}</span></div>
    </div>
    <h4>ğŸ“¦ å•†å“å…§å®¹</h4>
    ${(r.items||[]).map(i=>`<p>â— ${i.name} Ã— ${i.qty}</p>`).join('')}
    <button class="btn btn-primary" style="width:100%" onclick="closeModal()">é—œé–‰</button>
  `);
}

/* =========================
   åŸæœ¬ Inventory / Listing
   â— å®Œå…¨ä¸å‹•
========================= */

function renderInventory(){ /* åŸæ¨£ */ }
function renderListing(){ /* åŸæ¨£ */ }

/* =========================
   onloadï¼ˆåªæ”¹é€™è£¡ï¼‰
========================= */

window.onload = () => {
  fetchOrdersFromAPI();   // â† çœŸè³‡æ–™
  renderInventory();     // â† å‡è³‡æ–™
  renderListing();       // â† å‡è³‡æ–™
};

/* ===== Modal helpers åŸæ¨£ ===== */
function openModal(h){document.getElementById('modalBody').innerHTML=h;document.getElementById('mainModal').style.display='flex'}
function closeModal(){document.getElementById('mainModal').style.display='none'}

</script>
</body>
</html>
