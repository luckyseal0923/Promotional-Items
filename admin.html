<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å…¬é—œå“å¾Œè‡ºç®¡ç†ç³»çµ±</title>
<style>
:root {
  --primary: #10B981;
  --primary-dark: #059669;
  --bg: #F8FAFC;
  --text: #334155;
  --border: #E2E8F0;
  --danger: #EF4444;
  --warning: #F59E0B;
}
body,html{margin:0;height:100%;font-family:"PingFang TC",sans-serif;background:var(--bg);color:var(--text)}
.hidden{display:none!important}
.sidebar{width:260px;background:#fff;height:100vh;position:fixed;padding:24px;border-right:1px solid var(--border);box-sizing:border-box;z-index:100}
.main-content{margin-left:260px;padding:30px}
@media (max-width: 900px) {
  .sidebar{width:70px;padding:15px 5px;text-align:center}
  .sidebar h2,.sidebar .nav-text{display:none}
  .main-content{margin-left:70px;padding:15px}
}
.nav-item{padding:14px 18px;border-radius:10px;margin-bottom:8px;cursor:pointer;color:#64748B;display:flex;align-items:center;gap:12px;transition:0.2s}
.nav-item.active{background:var(--primary);color:#fff;font-weight:bold}
.panel{background:#fff;border-radius:12px;padding:24px;border:1px solid var(--border);margin-bottom:24px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
h1{font-size:22px;border-left:5px solid var(--primary);padding-left:14px;margin-bottom:24px;color:#0F172A}
table{width:100%;border-collapse:collapse;min-width:800px}
th{text-align:left;padding:12px;background:#F8FAFC;border-bottom:2px solid var(--border);font-size:13px}
td{padding:16px 12px;border-bottom:1px solid var(--border);font-size:14px}
.table-wrapper{overflow-x:auto}
.btn{padding:10px 16px;border-radius:8px;border:none;cursor:pointer;font-size:13px;font-weight:600;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:var(--primary);color:#fff}
.btn-success{background:#10B981;color:#fff}
.btn-outline{background:#fff;border:1px solid var(--border);color:var(--text)}
.btn-danger{background:var(--danger);color:#fff}
.status-pill{padding:4px 10px;border-radius:6px;font-size:12px;font-weight:bold}
.status-preparing{background:#DBEAFE;color:#1E40AF}
.status-submitted{background:#FEF3C7;color:#92400E}
.status-ready{background:#D1FAE5;color:#065F46}
.status-exception{background:#FEE2E2;color:#991B1B}
.status-end{background:#E5E7EB;color:#374151}
input,select{padding:12px;border:1px solid var(--border);border-radius:8px;outline:none;box-sizing:border-box;font-size:14px}
input:focus,select:focus{border-color:var(--primary)}
.modal{position:fixed;inset:0;background:rgba(15,23,42,0.5);display:none;align-items:center;justify-content:center;z-index:5000;padding:15px}
.modal.show{display:flex}
.modal-body{background:#fff;padding:30px;border-radius:16px;width:100%;max-width:550px;max-height:90vh;overflow-y:auto}
.modal-title{margin:0 0 20px 0;font-size:18px;color:#0F172A}
.info-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px dashed #E2E8F0}
.info-label{color:#64748B;font-size:14px}
.info-value{font-weight:600;font-size:14px}
.item-list{background:#F8FAFC;padding:12px;border-radius:8px;margin:10px 0}
.item-row{display:flex;justify-content:space-between;padding:6px 0}
</style>
</head>
<body>
<div id="adminView">
  <div class="sidebar">
    <h2 style="color:var(--primary-dark);margin-bottom:30px">å…¬é—œå“å¾Œè‡º</h2>
    <div class="nav-item active" id="nav-orders" onclick="switchTab('orders')">ğŸ“‹ <span class="nav-text">è¨‚å–®ç®¡ç†ç³»çµ±</span></div>
    <div class="nav-item" id="nav-inventory" onclick="switchTab('inventory')">âš–ï¸ <span class="nav-text">åº«å­˜ç›¤é»</span></div>
    <div class="nav-item" id="nav-listing" onclick="switchTab('listing')">ğŸš€ <span class="nav-text">å•†å“ç®¡ç†</span></div>
    <div class="nav-item" id="nav-accounts" onclick="switchTab('accounts')">ğŸ‘¥ <span class="nav-text">å¸³è™Ÿç®¡ç†</span></div>
    <div style="margin-top:50px"><button class="btn btn-outline" style="width:100%">å®‰å…¨ç™»å‡º</button></div>
  </div>
  <div class="main-content">
    <div id="tab-orders">
      <h1>è¨‚å–®ç®¡ç†ç³»çµ±</h1>
      <div id="orderError" class="hidden" style="padding:14px;border-radius:10px;background:#FEE2E2;color:#991B1B;font-weight:bold;margin-bottom:16px">âš ï¸ è¨‚å–®è³‡æ–™ç›®å‰ç„¡æ³•è¼‰å…¥ï¼Œè«‹ç¨å¾Œå†è©¦</div>
      <div class="panel">
        <div style="display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;align-items:center">
          <input type="date" id="dateFrom" onchange="filterOrders()">
          <span>è‡³</span>
          <input type="date" id="dateTo" onchange="filterOrders()">
          <select id="statusFilter" onchange="filterOrders()" style="min-width:120px">
            <option value="">å…¨éƒ¨ç‹€æ…‹</option>
            <option value="Submitted">ç”³è«‹æå‡º</option>
            <option value="PREPARING">å•†å“æº–å‚™ä¸­</option>
            <option value="ready">é€šçŸ¥é ˜å–</option>
            <option value="EXCEPTION">ç•°å¸¸é€šçŸ¥</option>
            <option value="End">æ¡ˆä»¶çµæ¡ˆ</option>
          </select>
<input type="text" id="searchKeyword" placeholder="æœå°‹å–®è™Ÿ/ç”³è«‹äºº" style="width:150px">
<button class="btn btn-primary" onclick="filterOrders()">ğŸ” ç¯©é¸</button>
<button class="btn btn-outline" onclick="resetFilter()">é‡ç½®</button>
<button class="btn btn-success" onclick="downloadCSV()">ğŸ“¥ ä¸‹è¼‰å ±è¡¨</button>
        </div>
        <div class="table-wrapper">
          <table>
            <<thead><tr><th>æ—¥æœŸ / å–®è™Ÿ</th><th>ç”³è«‹äºº</th><th>å–®ä½</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="orderTable"><tr><td colspan="5" style="text-align:center;color:#666;padding:30px">è¼‰å…¥ä¸­...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
    <div id="tab-inventory" class="hidden"><h1>åº«å­˜ç›¤é»</h1><div class="panel">ï¼ˆåŠŸèƒ½é–‹ç™¼ä¸­ï¼‰</div></div>
    <div id="tab-listing" class="hidden"><h1>å•†å“ç®¡ç†</h1><div class="panel">ï¼ˆåŠŸèƒ½é–‹ç™¼ä¸­ï¼‰</div></div>
    <div id="tab-accounts" class="hidden"><h1>å¸³è™Ÿç®¡ç†</h1><div class="panel">ï¼ˆåŠŸèƒ½é–‹ç™¼ä¸­ï¼‰</div></div>
  </div>
</div>
<div id="orderModal" class="modal">
  <div class="modal-body">
    <h3 class="modal-title">ğŸ“‹ è¨‚å–®è©³ç´°è³‡è¨Š</h3>
    <div id="orderDetail"></div>
    <button class="btn btn-primary" style="width:100%;margin-top:20px" onclick="closeModal()">é—œé–‰</button>
  </div>
</div>

  <script>
const API_ORDERS = 'https://chihwei-n8n.zeabur.app/webhook/orders';
let ALL_ORDERS = [];
let FILTERED_ORDERS = [];
const STATUS_MAP = {
  'Submitted':'ç”³è«‹æå‡º','PREPARING':'å•†å“æº–å‚™ä¸­','preparing':'å•†å“æº–å‚™ä¸­',
  'ready':'é€šçŸ¥é ˜å–','EXCEPTION':'ç•°å¸¸é€šçŸ¥','End':'æ¡ˆä»¶çµæ¡ˆ','done':'æ¡ˆä»¶çµæ¡ˆ','closed':'æ¡ˆä»¶çµæ¡ˆ'
};
const STATUS_CLASS_MAP = {
  'Submitted':'status-submitted','PREPARING':'status-preparing','preparing':'status-preparing',
  'ready':'status-ready','EXCEPTION':'status-exception','End':'status-end','done':'status-end','closed':'status-end'
};
function getStatusText(s){return STATUS_MAP[s]||s||'æœªçŸ¥';}
function getStatusClass(s){return STATUS_CLASS_MAP[s]||'status-preparing';}
function formatDate(d) {
  if (!d) return '-';
  const n = new Date(d);
  if (isNaN(n)) return d;
  const y = n.getFullYear();
  const m = String(n.getMonth() + 1).padStart(2, '0');
  const day = String(n.getDate()).padStart(2, '0');
  return y + '/' + m + '/' + day;
}
function formatDateTime(d){if(!d)return'-';const n=new Date(d);return isNaN(n)?d:n.toLocaleString('zh-TW');}
function switchTab(tab){
  ['orders','inventory','listing','accounts'].forEach(t=>{
    document.getElementById('tab-'+t).classList.add('hidden');
    document.getElementById('nav-'+t).classList.remove('active');
  });
  document.getElementById('tab-'+tab).classList.remove('hidden');
  document.getElementById('nav-'+tab).classList.add('active');
}
async function loadOrders(){
  try{
    const res=await fetch(API_ORDERS);
    if(!res.ok)throw new Error('API error');
    const data=await res.json();
    ALL_ORDERS=[...(data.orders?.active||[]),...(data.orders?.archived||[])];
    FILTERED_ORDERS=[...ALL_ORDERS];
    console.log('è¼‰å…¥è¨‚å–®æˆåŠŸ:',ALL_ORDERS.length,'ç­†');
    document.getElementById('orderError').classList.add('hidden');
    renderOrders();
  }catch(e){
    console.warn('è¨‚å–®è¼‰å…¥å¤±æ•—',e);
    document.getElementById('orderError').classList.remove('hidden');
    document.getElementById('orderTable').innerHTML='<tr><td colspan="6" style="text-align:center;color:#991B1B;padding:30px">è¼‰å…¥å¤±æ•—</td></tr>';
  }
}
function downloadCSV() {
  if (FILTERED_ORDERS.length === 0) {
    alert('æ²’æœ‰è³‡æ–™å¯ä¸‹è¼‰');
    return;
  }
  let csv = '\uFEFFæ—¥æœŸ,å–®è™Ÿ,ç”³è«‹äºº,å–®ä½,ç‹€æ…‹,é‡‘é¡\n';
  csv += FILTERED_ORDERS.map(o => 
    '"' + formatDate(o.date) + '","' + (o.task_id || '') + '","' + (o.user || '') + '","' + (o.department || '') + '","' + getStatusText(o.status) + '","' + (o.total || 0) + '"'
  ).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'è¨‚å–®å ±è¡¨_' + new Date().toISOString().slice(0, 10) + '.csv';
  link.click();
}    
function filterOrders() {
  const df = document.getElementById('dateFrom').value;
  const dt = document.getElementById('dateTo').value;
  const sf = document.getElementById('statusFilter').value;
  const kw = document.getElementById('searchKeyword').value.toLowerCase().trim();
  
  FILTERED_ORDERS = ALL_ORDERS.filter(o => {
    if (df || dt) {
      const od = o.date ? new Date(o.date).toISOString().split('T')[0] : '';
      if (df && od < df) return false;
      if (dt && od > dt) return false;
    }
    if (sf && o.status !== sf) return false;
    if (kw) {
      const matchId = (o.task_id || '').toLowerCase().includes(kw);
      const matchUser = (o.user || '').toLowerCase().includes(kw);
      if (!matchId && !matchUser) return false;
    }
    return true;
  });
  renderOrders();
}
function resetFilter() {
  document.getElementById('dateFrom').value = '';
  document.getElementById('dateTo').value = '';
  document.getElementById('statusFilter').value = '';
  document.getElementById('searchKeyword').value = '';
  FILTERED_ORDERS = [...ALL_ORDERS];
  renderOrders();
}
function renderOrders() {
  const tb = document.getElementById('orderTable');
  if (FILTERED_ORDERS.length === 0) {
    tb.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#666;padding:30px">å°šç„¡è¨‚å–®è³‡æ–™</td></tr>';
    return;
  }
  tb.innerHTML = FILTERED_ORDERS.map(o =>
    '<tr>' +
      '<td style="line-height:1.5;width:140px">' +
        '<div style="font-size:14px;font-weight:600;color:#0F172A">' + formatDate(o.date) + '</div>' +
        '<div style="font-size:11px;color:#94A3B8">' + (o.task_id || '-') + '</div>' +
      '</td>' +
      '<td>' + (o.user || '-') + '</td>' +
      '<td>' + (o.department || '-') + '</td>' +
      '<td><span class="status-pill ' + getStatusClass(o.status) + '">' + getStatusText(o.status) + '</span></td>' +
      '<td style="white-space:nowrap">' +
        '<button class="btn btn-outline" style="margin-right:4px" onclick="showOrderDetail(\'' + o.task_id + '\')">ğŸ“‹ æŸ¥è©¢</button>' +
        '<button class="btn btn-primary" onclick="showEditStatus(\'' + o.task_id + '\')">âœï¸ ç‹€æ…‹</button>' +
      '</td>' +
    '</tr>'
  ).join('');
}
function showOrderDetail(tid) {
  const o = ALL_ORDERS.find(x => x.task_id === tid);
  if (!o) { alert('æ‰¾ä¸åˆ°æ­¤è¨‚å–®'); return; }
  
  let ih = o.items && o.items.length > 0 
    ? o.items.map(i => '<div class="item-row"><span>' + (i.item_name || i.name || 'æœªçŸ¥å•†å“') + '</span><span>x' + (i.quantity || i.qty || 1) + ' / $' + (i.subtotal || 0) + '</span></div>').join('') 
    : '<p style="color:#666">ç„¡å•†å“æ˜ç´°</p>';
  
  let dh = '<div style="background:#F8FAFC;padding:16px;border-radius:10px;margin-bottom:16px">';
  dh += '<div class="info-row"><span class="info-label">è¨‚å–®ç·¨è™Ÿ</span><span class="info-value">' + (o.task_id || '-') + '</span></div>';
  dh += '<div class="info-row"><span class="info-label">ç”³è«‹æ™‚é–“</span><span class="info-value">' + formatDateTime(o.date) + '</span></div>';
  dh += '<div class="info-row"><span class="info-label">ç”³è«‹äºº</span><span class="info-value">' + (o.user || '-') + '</span></div>';
  dh += '<div class="info-row"><span class="info-label">é™¢å…§å“¡ç·¨</span><span class="info-value">' + (o.staff_id || '-') + '</span></div>';
  dh += '<div class="info-row"><span class="info-label">ç”³è«‹è€…é›»è©±</span><span class="info-value">' + (o.phone || '-') + '</span></div>';
  dh += '<div class="info-row"><span class="info-label">é›»å­ä¿¡ç®±</span><span class="info-value">' + (o.email || '-') + '</span></div>';
  dh += '<div class="info-row"><span class="info-label">ç”³è«‹å–®ä½</span><span class="info-value">' + (o.department || '-') + '</span></div>';
  dh += '<div class="info-row"><span class="info-label">æˆæœ¬ä¸­å¿ƒ</span><span class="info-value">' + (o.cost_center || '-') + '</span></div>';
  dh += '<div class="info-row"><span class="info-label">ç”³è«‹äº‹ç”±</span><span class="info-value">' + (o.reason || '-') + '</span></div>';
  dh += '<div class="info-row"><span class="info-label">è¨‚å–®ç‹€æ…‹</span><span class="info-value"><span class="status-pill ' + getStatusClass(o.status) + '">' + getStatusText(o.status) + '</span></span></div>';
 
  // ğŸ”¥ æ–°å¢ï¼šç•°å¸¸åŸå› é¡¯ç¤ºå€å¡Š
  if (o.status === 'EXCEPTION' && o.comment) {
    dh += '<div style="margin:10px 0;padding:12px;background:#FEF2F2;border-left:4px solid #EF4444;border-radius:4px;">';
    dh += '<strong style="color:#991B1B;display:block;margin-bottom:4px;font-size:13px;">ğŸ”´ ç•°å¸¸åŸå› ï¼š</strong>';
    dh += '<span style="color:#7F1D1D;font-weight:bold;">' + o.comment + '</span>';
    dh += '</div>';
  }
  
  dh += '<div class="info-row"><span class="info-label">è¨‚å–®é‡‘é¡</span><span class="info-value" style="color:var(--primary)">$' + (o.total || 0) + '</span></div>';
  dh += '</div><h4 style="margin:16px 0 8px 0;color:#0F172A">ğŸ“¦ å•†å“æ˜ç´°</h4><div class="item-list">' + ih + '</div>';
  
  document.getElementById('orderDetail').innerHTML = dh;
  document.getElementById('orderModal').classList.add('show');
}
function closeModal(){document.getElementById('orderModal').classList.remove('show');}
document.getElementById('orderModal').addEventListener('click',function(e){if(e.target===this)closeModal();});
window.onload=function(){loadOrders();};
function showEditStatus(tid) {
  const o = ALL_ORDERS.find(x => x.task_id === tid);
  if (!o) { alert('æ‰¾ä¸åˆ°æ­¤è¨‚å–®'); return; }
  
  let dh = '<div style="margin-bottom:16px">';
  dh += '<div class="info-row"><span class="info-label">è¨‚å–®ç·¨è™Ÿ</span><span class="info-value">' + (o.task_id || '-') + '</span></div>';
  dh += '<div class="info-row"><span class="info-label">ç›®å‰ç‹€æ…‹</span><span class="info-value"><span class="status-pill ' + getStatusClass(o.status) + '">' + getStatusText(o.status) + '</span></span></div>';
  dh += '</div>';
  
  dh += '<label style="font-size:14px;font-weight:600;margin-bottom:8px;display:block">è®Šæ›´ç‚ºï¼š</label>';
  // åŠ å…¥ onchange äº‹ä»¶
  dh += '<select id="newStatus" style="width:100%" onchange="toggleReasonField()">';
  dh += '<option value="Submitted"' + (o.status === 'Submitted' ? ' selected' : '') + '>ç”³è«‹æå‡º</option>';
  dh += '<option value="PREPARING"' + (o.status === 'PREPARING' ? ' selected' : '') + '>å•†å“æº–å‚™ä¸­</option>';
  dh += '<option value="ready"' + (o.status === 'ready' ? ' selected' : '') + '>é€šçŸ¥é ˜å–</option>';
  dh += '<option value="EXCEPTION"' + (o.status === 'EXCEPTION' ? ' selected' : '') + '>ç•°å¸¸é€šçŸ¥ (éœ€å¡«åŸå› )</option>';
  dh += '<option value="End"' + (o.status === 'End' ? ' selected' : '') + '>æ¡ˆä»¶çµæ¡ˆ</option>';
  dh += '</select>';
  
  // æ–°å¢ç•°å¸¸åŸå› è¼¸å…¥æ¡†
  dh += '<div id="reasonField" style="display:none; margin-top:12px;">';
  dh += '<label style="color:#EF4444;font-size:13px;font-weight:bold;margin-bottom:4px;display:block">ç•°å¸¸åŸå›  (å¿…å¡«)ï¼š</label>';
  dh += '<textarea id="statusNote" rows="3" style="width:100%;padding:8px;border:1px solid #EF4444;border-radius:6px;" placeholder="è«‹èªªæ˜ç•°å¸¸åŸå› ..."></textarea>';
  dh += '</div>';

  dh += '<button class="btn btn-success" style="width:100%;margin-top:16px" onclick="updateStatus(\'' + tid + '\')">ğŸ’¾ å„²å­˜è®Šæ›´</button>';
  
  document.getElementById('orderDetail').innerHTML = dh;
  document.getElementById('orderModal').classList.add('show');
  
  // åˆå§‹åŒ–æª¢æŸ¥
  toggleReasonField();
}

// æ–°å¢ Helper å‡½å¼
function toggleReasonField() {
  const status = document.getElementById('newStatus').value;
  const reasonDiv = document.getElementById('reasonField');
  if (status === 'EXCEPTION') {
    reasonDiv.style.display = 'block';
  } else {
    reasonDiv.style.display = 'none';
  }
}

function updateStatus(tid) {
  const newStatus = document.getElementById('newStatus').value;
  const note = document.getElementById('statusNote') ? document.getElementById('statusNote').value.trim() : '';
  const btn = event.target;
  
  // é˜²å‘†æª¢æŸ¥ï¼šç•°å¸¸ç‹€æ…‹å¿…å¡«åŸå› 
  if (newStatus === 'EXCEPTION' && !note) {
    alert('âŒ è«‹å¡«å¯«ç•°å¸¸åŸå› ï¼');
    document.getElementById('statusNote').focus();
    return;
  }
  
  btn.disabled = true;
  btn.textContent = 'è™•ç†ä¸­...';
  
  fetch('https://chihwei-n8n.zeabur.app/webhook/update-order', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      task_id: tid,
      status: newStatus,
      comment: note, // æ–°å¢æ¬„ä½
      updated_at: new Date().toISOString()
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert('âœ… ç‹€æ…‹å·²æ›´æ–°');
      closeModal();
      loadOrders();
    } else {
      alert('âŒ æ›´æ–°å¤±æ•—ï¼š' + (data.message || 'æœªçŸ¥éŒ¯èª¤'));
    }
  })
  .catch(e => {
    alert('âŒ é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
    console.error(e);
  })
  .finally(() => {
    btn.disabled = false;
    btn.textContent = 'ğŸ’¾ å„²å­˜è®Šæ›´';
  });
}
</script>
</body>
</html>
