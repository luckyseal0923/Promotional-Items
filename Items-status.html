<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>å…¬é—œå“ç”³è«‹ç‹€æ…‹çœ‹æ¿</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, "Noto Sans TC", Arial, sans-serif;
  background:#f6f7f9;
  padding:20px;
}
h1 { text-align:center; margin-bottom:20px; }

/* ===== æŸ¥è©¢ ===== */
.search-box {
  max-width:1200px;
  margin:0 auto 24px;
  display:flex;
  gap:10px;
}
.search-box input {
  flex:1; padding:10px; border-radius:8px;
  border:1px solid #ccc; font-size:14px;
}
.search-box button {
  padding:10px 16px; border:none; border-radius:8px;
  background:#0A84FF; color:#fff; cursor:pointer;
}

/* ===== å¡ç‰‡ ===== */
.board {
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
  gap:20px;
  max-width:1200px;
  margin:auto;
}
.card {
  background:#fff; border-radius:12px; padding:16px;
  box-shadow:0 2px 10px rgba(0,0,0,0.08);
}
.title { font-size:18px; font-weight:700; margin-bottom:6px; }
.sub { font-size:14px; margin-bottom:4px; }
.money { font-size:15px; font-weight:600; margin-top:6px; }

/* ===== ç‹€æ…‹åˆ— ===== */
.timeline { display:flex; align-items:center; margin:14px 0; }
.step {
  flex:1; text-align:center; font-size:12px;
  position:relative; color:#999;
}
.step::before {
  content:''; display:block; width:14px; height:14px;
  margin:0 auto 6px; border-radius:50%; background:#ccc;
}
.step::after {
  content:''; position:absolute; top:7px; left:50%;
  width:100%; height:2px; background:#ccc; z-index:-1;
}
.step:last-child::after { display:none; }
.step.done { color:#0A84FF; }
.step.done::before, .step.done::after { background:#0A84FF; }
.step.current { color:#28a745; font-weight:bold; }
.step.current::before { background:#28a745; }
.step.exception { color:#dc3545; font-weight:bold; }
.step.exception::before { background:#dc3545; }

/* ===== æ˜ç´° ===== */
.details {
  display:none; margin-top:10px; font-size:13px;
  color:#555; border-top:1px dashed #ddd; padding-top:10px;
}
.toggle-btn {
  margin-top:8px; background:none; border:none;
  color:#0A84FF; cursor:pointer; font-size:14px;
}

/* ===== çµæ¡ˆæ¸…å–® ===== */
.archive { max-width:1200px; margin:40px auto 0; }
.archive h3 { cursor:pointer; font-size:16px; }
.archive table {
  width:100%; border-collapse:collapse;
  background:#fff; margin-top:10px; display:none;
}
.archive th, .archive td {
  border-bottom:1px solid #eee;
  padding:8px; font-size:14px; text-align:left;
}
.archive th {
  background:#f0f2f5; cursor:pointer; user-select:none;
}
.sort-icon { margin-left:6px; font-size:11px; color:#888; }
.sort-active { color:#0A84FF; font-weight:bold; }

  .nav-actions {
  max-width: 1200px;
  margin: 0 auto 16px;
  text-align: right;
}

.apply-btn {
  padding: 8px 16px;
  font-size: 14px;
  background: #f1f3f5;      /* æ·ºç°åº• */
  color: #0A84FF;           /* ä¸»ç³»çµ±è— */
  border: 1px solid #cfe0ff;
  border-radius: 8px;
  cursor: pointer;
}

.apply-btn:hover {
  background: #e7f1ff;
}
</style>
</head>

<body>

<h1>ğŸ“¦ å…¬é—œå“ç”³è«‹ç‹€æ…‹çœ‹æ¿</h1>
<div class="nav-actions">
  <button
    class="apply-btn"
    onclick="window.location.href='https://promotional-items-booking.zeabur.app/'"
  >
    â• æ–°å¢æ¡ˆä»¶ç”³è«‹
  </button>
</div>
<div class="search-box">
  <input id="staffInput" placeholder="è¼¸å…¥å“¡ç·¨ï¼ˆ6ç¢¼ï¼‰æŸ¥è©¢" />
  <button onclick="loadData()">æŸ¥è©¢</button>
</div>

<div class="board" id="activeBoard"></div>
<div id="loadingHint" style="
  max-width:1200px;
  margin:40px auto;
  text-align:center;
  color:#666;
  font-size:16px;
">
  â³ è³‡æ–™è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™â€¦
</div>
<div class="archive">
  <h3 onclick="toggleArchive()">â–¸ çµæ¡ˆæ¸…å–®ï¼ˆè¿‘åŠå¹´ï¼‰</h3>
  <table id="archiveTable">
    <thead>
      <tr>
        <th>è¨‚å–®ç·¨è™Ÿ</th>
        <th>ç”³è«‹äºº</th>
        <th>éƒ¨é–€</th>
        <th>è³¼è²·å…§å®¹</th>
        <th>ç¸½é‡‘é¡</th>
        <th>çµæ¡ˆæ—¥æœŸ</th>
      </tr>
    </thead>
    <tbody id="archiveBody"></tbody>
  </table>
</div>

<script>
let ALL_DATA = [];
const API_URL = 'https://chihwei-n8n.zeabur.app/webhook/items-status';

/* ===== æ™‚é–“æ ¼å¼çµ±ä¸€ ===== */
function fmtDateTime(v) {
  if (!v) return '';
  const d = new Date(v);
  if (isNaN(d)) return v;

  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  const h = String(d.getHours()).padStart(2, '0');
  const min = String(d.getMinutes()).padStart(2, '0');
  return `${y}-${m}-${day} ${h}:${min}`;
}

/* ===== ä¸»è¦è¼‰å…¥ ===== */
async function loadData(){

  // é¡¯ç¤º loading
  document.getElementById('loadingHint').style.display = 'block';
  document.getElementById('activeBoard').innerHTML = '';
  document.getElementById('archiveBody').innerHTML = '';

  try {
    const res = await fetch(API_URL);
    const data = await res.json();

    // âœ… çµ±ä¸€è³‡æ–™ä¾†æº
    ALL_DATA = [
      ...(data.active || []),
      ...(data.archived || [])
    ];

    // âœ… åªäº¤çµ¦å‰ç«¯ç¯©é¸ï¼ˆapplyFilter å…§éƒ¨æœƒåš status åˆ†é¡ï¼‰
    applyFilter();

    // éš±è— loading
    document.getElementById('loadingHint').style.display = 'none';

  } catch (e) {
    console.error('loadData failed', e);
    document.getElementById('loadingHint').textContent =
      'âš ï¸ è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
  }
}


  } catch (e) {
    console.error('loadData failed', e);
  }
}

function renderActive(list){
  const box = document.getElementById('activeBoard');
  box.innerHTML = '';

  list.forEach(o=>{
    box.innerHTML += `
    <div class="card">
      <div class="title">${o.applicant_name}ï¼ˆ${o.staff_id}ï¼‰ï½œ${o.department}</div>
      <div class="sub">è¨‚å–®ç·¨è™Ÿï¼š${o.task_id}</div>
      <div class="sub">ç”³è«‹æ—¥æœŸï¼š${fmtDateTime(o.apply_date)}</div>
      <div class="money">ç¸½é‡‘é¡ï¼šNT$ ${o.total_amount}</div>

<div class="timeline">
  <div class="step done">ç”³è«‹æå‡º</div>

  <div class="step ${
    o.status === 'PREPARING' ? 'current'
    : ['ready','EXCEPTION','End'].includes(o.status) ? 'done' : ''
  }">å•†å“æº–å‚™ä¸­</div>

  <div class="step ${
    o.status === 'ready' ? 'current'
    : ['End'].includes(o.status) ? 'done' : ''
  }">å·²é€šçŸ¥é ˜å–</div>

  <div class="step ${
    o.status === 'EXCEPTION' ? 'exception current' : ''
  }">ç•°å¸¸é€šçŸ¥</div>
</div>

      <button class="toggle-btn" onclick="toggleDetails(this)">æŸ¥çœ‹æ¡ˆä»¶æ˜ç´°</button>
      <div class="details">
        ${(o.items || []).map(i=>`${i.name} Ã— ${i.qty}`).join('<br>')}
      </div>
    </div>`;
  });
}

function renderArchive(list){
  const body = document.getElementById('archiveBody');
  body.innerHTML = '';

  list.forEach(o=>{
    body.innerHTML += `
    <tr>
      <td>${o.task_id}</td>
      <td>${o.applicant_name}ï¼ˆ${o.staff_id}ï¼‰</td>
      <td>${o.department}</td>
      <td>${o.items.map(i=>`${i.name} Ã— ${i.qty}`).join('<br>')}</td>
      <td>NT$ ${o.total_amount}</td>
      <td>${fmtDateTime(o.close_date || o.updated_at)}</td>
    </tr>`;
  });
}

function toggleDetails(btn){
  const d = btn.nextElementSibling;
  const open = d.style.display === 'block';
  d.style.display = open ? 'none' : 'block';
  btn.textContent = open ? 'æŸ¥çœ‹æ¡ˆä»¶æ˜ç´°' : 'æ”¶åˆæ¡ˆä»¶æ˜ç´°';
}

function toggleArchive(){
  const t = document.getElementById('archiveTable');
  t.style.display = t.style.display === 'table' ? 'none' : 'table';
}

// åˆå§‹è¼‰å…¥ï¼ˆå¯è¦–éœ€æ±‚æ‹¿æ‰ï¼‰
loadData();
  function applyFilter() {
  const staff = document.getElementById('staffInput').value.trim();

  const filtered = staff
    ? ALL_DATA.filter(o => String(o.staff_id).includes(staff))
    : ALL_DATA;

  const ACTIVE_STATUS = ['SUBMITTED', 'PREPARING', 'READY', 'EXCEPTION'];

  const activeList = filtered.filter(o =>
    ACTIVE_STATUS.includes(
      String(o.status).trim().toUpperCase()
    )
  );

  const archiveList = filtered.filter(o =>
    String(o.status).trim().toUpperCase() === 'END'
  );

  renderActive(activeList);
  renderArchive(archiveList);
}
</script>

</body>
</html>
